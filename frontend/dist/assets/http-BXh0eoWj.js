var _=Object.defineProperty;var w=(e,t,o)=>t in e?_(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var h=(e,t,o)=>w(e,typeof t!="symbol"?t+"":t,o);const l={},d=(l==null?void 0:l.VITE_API_BASE)||"/api";class f extends Error{constructor(o,a="unknown_error",c,r){super(o);h(this,"code");h(this,"requestId");h(this,"details");this.name="ApiError",this.code=a,this.requestId=c,this.details=r}}async function p(e){let t=`${e.status} ${e.statusText}`,o="http_error",a,c;try{const r=await e.json();if(r&&typeof r=="object"&&"error"in r){const n=r.error;t=(n==null?void 0:n.message)||t,o=(n==null?void 0:n.code)||o,a=r.request_id,c=n==null?void 0:n.details}}catch{}return new f(t,o,a,c)}function y(){return typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():"idem_"+Math.random().toString(36).slice(2)+Date.now().toString(36)}let s=null,i=null;function I(e){s=e,window.__auth_tokens=e,e!=null&&e.access_token?localStorage.setItem("access_token",e.access_token):localStorage.removeItem("access_token")}function T(){s=null,window.__auth_tokens=null,localStorage.removeItem("access_token")}async function g(e,t={}){const o=e.startsWith("http")?e:d.replace(/\/$/,"")+e,a=new Headers(t.headers||{});!a.has("Content-Type")&&!(t.body instanceof FormData)&&a.set("Content-Type","application/json"),a.has("Accept")||a.set("Accept","application/json"),s!=null&&s.access_token&&!a.has("Authorization")&&a.set("Authorization",`Bearer ${s.access_token}`);const c=(t.method||"GET").toUpperCase();(c!=="GET"&&c!=="HEAD"||t.idempotent)&&(a.has("Idempotency-Key")||a.set("Idempotency-Key",y()));let n=await fetch(o,{...t,headers:a});if(n.status===401&&(s!=null&&s.refresh_token))try{await m();const u=new Headers(a);s!=null&&s.access_token&&u.set("Authorization",`Bearer ${s.access_token}`),n=await fetch(o,{...t,headers:u})}catch{}if(!n.ok)throw await p(n);return n.status===204?void 0:(n.headers.get("Content-Type")||"").includes("application/json")?await n.json():await n.text()}async function m(){if(i)return i;if(!(s!=null&&s.refresh_token))throw new f("No refresh token","no_refresh_token");return i=(async()=>{const e=d.replace(/\/$/,"")+"/auth/refresh",t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({refresh_token:s.refresh_token})});if(!t.ok)throw i=null,s=null,await p(t);const o=await t.json();s={access_token:o.access_token,refresh_token:o.refresh_token??s.refresh_token,expires_in:o.expires_in},window.__auth_tokens=s,localStorage.setItem("access_token",s.access_token),i=null})(),i}export{g as a,T as c,m as r,I as s};
