var _=Object.defineProperty;var w=(e,t,o)=>t in e?_(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var h=(e,t,o)=>w(e,typeof t!="symbol"?t+"":t,o);import{i as y}from"./idempotency-C3fxGORY.js";const l={},f=(l==null?void 0:l.VITE_API_BASE)||"/api";class d extends Error{constructor(o,n="unknown_error",c,r){super(o);h(this,"code");h(this,"requestId");h(this,"details");this.name="ApiError",this.code=n,this.requestId=c,this.details=r}}async function p(e){let t=`${e.status} ${e.statusText}`,o="http_error",n,c;try{const r=await e.json();if(r&&typeof r=="object"&&"error"in r){const a=r.error;t=(a==null?void 0:a.message)||t,o=(a==null?void 0:a.code)||o,n=r.request_id,c=a==null?void 0:a.details}}catch{}return new d(t,o,n,c)}let s=null,i=null;function T(e){s=e,window.__auth_tokens=e,e!=null&&e.access_token?localStorage.setItem("access_token",e.access_token):localStorage.removeItem("access_token")}function E(){s=null,window.__auth_tokens=null,localStorage.removeItem("access_token")}async function j(e,t={}){const o=e.startsWith("http")?e:f.replace(/\/$/,"")+e,n=new Headers(t.headers||{});!n.has("Content-Type")&&!(t.body instanceof FormData)&&n.set("Content-Type","application/json"),n.has("Accept")||n.set("Accept","application/json"),s!=null&&s.access_token&&!n.has("Authorization")&&n.set("Authorization",`Bearer ${s.access_token}`);const c=(t.method||"GET").toUpperCase();(c!=="GET"&&c!=="HEAD"||t.idempotent)&&(n.has("Idempotency-Key")||n.set("Idempotency-Key",y()));let a=await fetch(o,{...t,headers:n});if(a.status===401&&(s!=null&&s.refresh_token))try{await m();const u=new Headers(n);s!=null&&s.access_token&&u.set("Authorization",`Bearer ${s.access_token}`),a=await fetch(o,{...t,headers:u})}catch{}if(!a.ok)throw await p(a);return a.status===204?void 0:(a.headers.get("Content-Type")||"").includes("application/json")?await a.json():await a.text()}async function m(){if(i)return i;if(!(s!=null&&s.refresh_token))throw new d("No refresh token","no_refresh_token");return i=(async()=>{const e=f.replace(/\/$/,"")+"/auth/refresh",t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({refresh_token:s.refresh_token})});if(!t.ok)throw i=null,s=null,await p(t);const o=await t.json();s={access_token:o.access_token,refresh_token:o.refresh_token??s.refresh_token,expires_in:o.expires_in},window.__auth_tokens=s,localStorage.setItem("access_token",s.access_token),i=null})(),i}export{j as a,E as c,m as r,T as s};
