import{r as f,j as e,a as D,u as O,R as z}from"./index-FkM6qUsl.js";import{B as E}from"./Button-t5z5qQ-u.js";import{M as R}from"./Modal-Cg6TzCa0.js";import{I as $}from"./Input-THmdJdCV.js";import{P as H}from"./Popover-rf5hZEbw.js";import{a as b}from"./http-B8UuqdIS.js";import{C as G}from"./Card-B3djX2B0.js";import"./idempotency-C3fxGORY.js";const q="_shell_kpuk2_1",J="_main_kpuk2_12",I={shell:q,main:J},F="_sidebar_10w9z_1",K="_head_10w9z_13",W="_title_10w9z_19",Q="_list_10w9z_22",V="_row_10w9z_30",X="_kebabBtn_10w9z_44",Y="_active_10w9z_47",Z="_item_10w9z_51",ee="_name_10w9z_70",se="_tags_10w9z_79",te="_tag_10w9z_79",ae="_menu_10w9z_115",ne="_undoBar_10w9z_141",oe="_undoText_10w9z_153",re="_undoBtn_10w9z_158",p={sidebar:F,head:K,title:W,list:Q,row:V,kebabBtn:X,active:Y,item:Z,name:ee,tags:se,tag:te,menu:ae,undoBar:ne,undoText:oe,undoBtn:re};async function*ie(s){const a=s.getReader(),t=new TextDecoder;let r="";try{for(;;){const{value:i,done:d}=await a.read();if(d)break;r+=t.decode(i,{stream:!0});let m;for(;(m=r.indexOf(`

`))!==-1;){const x=r.slice(0,m).trim();if(r=r.slice(m+2),!x)continue;const h={};for(const y of x.split(`
`)){const[l,...c]=y.split(":"),C=c.join(":").trimStart();l==="event"?h.event=C:l==="data"?h.data=(h.data?h.data+`
`:"")+C:l==="id"&&(h.id=C)}yield h}}}finally{a.releaseLock()}}async function ce(s={}){const a=new URLSearchParams;return s.limit&&a.set("limit",String(s.limit)),s.cursor&&a.set("cursor",s.cursor),s.q&&a.set("q",s.q),b(`/chats?${a.toString()}`)}async function le(s,a){return b("/chats",{method:"POST",body:JSON.stringify({name:s??null,tags:a??null})})}async function de(s,a={}){const t=new URLSearchParams;return a.limit&&t.set("limit",String(a.limit)),a.cursor&&t.set("cursor",a.cursor),b(`/chats/${s}/messages?${t.toString()}`)}async function ue(s,a){return b(`/chats/${s}/messages`,{method:"POST",body:JSON.stringify(a),idempotent:!0})}async function*he(s,a){var x;const t={"Content-Type":"application/json"},r=((x=window.__auth_tokens)==null?void 0:x.access_token)||localStorage.getItem("access_token");r&&(t.Authorization=`Bearer ${r}`);const d=await fetch(`/api/chats/${s}/messages`,{method:"POST",headers:t,body:JSON.stringify({...a,response_stream:!0})});if(!d.ok)throw new Error(`HTTP ${d.status}`);if((d.headers.get("content-type")||"").includes("text/event-stream"))for await(const h of ie(d.body))h.data&&(yield h.data);else{const h=d.body.getReader(),y=new TextDecoder;let l="";for(;;){const{value:c,done:C}=await h.read();if(C)break;l+=y.decode(c,{stream:!0});let g;for(;(g=l.indexOf(`
`))!==-1;){const S=l.slice(0,g).trim();l=l.slice(g+1),S&&(yield S)}}l.trim()&&(yield l.trim())}}async function me(s,a){const t={name:a};return b(`/chats/${s}`,{method:"PATCH",body:JSON.stringify(t)})}async function ye(s,a){const t={tags:a};return b(`/chats/${s}/tags`,{method:"PUT",body:JSON.stringify(t)})}async function P(s){return b(`/chats/${s}`,{method:"DELETE"})}const ge={isLoading:!1,error:null,chatsOrder:[],chatsById:{},messagesByChat:{},currentChatId:null};function _e(s,a){switch(a.type){case"SET_LOADING":return{...s,isLoading:a.payload};case"SET_ERROR":return{...s,error:a.payload};case"SET_CURRENT_CHAT":return{...s,currentChatId:a.payload};case"SET_CHATS":{const t={},r=[];for(const i of a.payload)t[i.id]=i,r.push(i.id);return{...s,chatsById:t,chatsOrder:r}}case"UPSERT_CHAT":{const t=a.payload.id,r=!!s.chatsById[t],i={...s.chatsById,[t]:{...s.chatsById[t],...a.payload}},d=r?s.chatsOrder:[t,...s.chatsOrder];return{...s,chatsById:i,chatsOrder:d}}case"DELETE_CHAT":{const{[a.payload]:t,...r}=s.chatsById;return{...s,chatsById:r,chatsOrder:s.chatsOrder.filter(i=>i!==a.payload)}}case"SET_MESSAGES":{const{chatId:t,items:r,nextCursor:i,hasMore:d}=a.payload,m={...s.messagesByChat,[t]:{items:r,nextCursor:i,hasMore:d,loaded:!0}};return{...s,messagesByChat:m}}case"APPEND_MESSAGES":{const{chatId:t,items:r,nextCursor:i,hasMore:d}=a.payload,x=[...(s.messagesByChat[t]||{items:[]}).items,...r];return{...s,messagesByChat:{...s.messagesByChat,[t]:{items:x,nextCursor:i,hasMore:d,loaded:!0}}}}case"ADD_MESSAGE":{const{chatId:t,item:r}=a.payload,i=s.messagesByChat[t]||{items:[],nextCursor:null,hasMore:!1,loaded:!1};return{...s,messagesByChat:{...s.messagesByChat,[t]:{...i,items:[...i.items,r],loaded:!0}}}}case"UPDATE_CHAT_PARTIAL":{const{chatId:t,patch:r}=a.payload,i=s.chatsById[t];return i?{...s,chatsById:{...s.chatsById,[t]:{...i,...r}}}:s}}}const L=f.createContext(void 0);function pe({children:s}){const[a,t]=f.useReducer(_e,ge),r=f.useRef(!1);async function i(){t({type:"SET_LOADING",payload:!0});try{const o=await ce({limit:100});t({type:"SET_CHATS",payload:o.items}),t({type:"SET_ERROR",payload:null})}catch(o){t({type:"SET_ERROR",payload:(o==null?void 0:o.message)||"failed_to_load_chats"})}finally{t({type:"SET_LOADING",payload:!1})}}async function d(){var n;(((n=window.__auth_tokens)==null?void 0:n.access_token)||localStorage.getItem("access_token"))&&await i()}f.useEffect(()=>{r.current||(r.current=!0,d())},[]);async function m(o,n){const _=(await le(o??null,n??null)).chat_id;return t({type:"UPSERT_CHAT",payload:{id:_,name:o??null,tags:n??null}}),_}async function x(o,n){await me(o,n),t({type:"UPDATE_CHAT_PARTIAL",payload:{chatId:o,patch:{name:n}}})}async function h(o){await P(o),t({type:"DELETE_CHAT",payload:o}),a.currentChatId===o&&t({type:"SET_CURRENT_CHAT",payload:null})}function y(o){t({type:"DELETE_CHAT",payload:o}),a.currentChatId===o&&t({type:"SET_CURRENT_CHAT",payload:null})}function l(o){t({type:"UPSERT_CHAT",payload:o})}async function c(o){await P(o)}async function C(o,n){await ye(o,n),t({type:"UPDATE_CHAT_PARTIAL",payload:{chatId:o,patch:{tags:n}}})}function g(o){t({type:"SET_CURRENT_CHAT",payload:o})}async function S(o,n){const u=a.messagesByChat[o];if(!n&&(u!=null&&u.loaded))return;const _=await de(o,n?{cursor:(u==null?void 0:u.nextCursor)||void 0}:{}),T=_.items,v=_.next_cursor??null,A=!!v&&T.length>0;t({type:n?"APPEND_MESSAGES":"SET_MESSAGES",payload:{chatId:o,items:T,nextCursor:v,hasMore:A}})}async function w(o,n,u){const _=await ue(o,{content:n,use_rag:!!u}),T={id:_.message_id,chat_id:o,role:"user",content:n};t({type:"ADD_MESSAGE",payload:{chatId:o,item:T}});const v={id:crypto.randomUUID(),chat_id:o,role:"assistant",content:_.answer};return t({type:"ADD_MESSAGE",payload:{chatId:o,item:v}}),_.message_id}async function k(o,n,u,_){t({type:"ADD_MESSAGE",payload:{chatId:o,item:{id:crypto.randomUUID(),chat_id:o,role:"user",content:n}}});let T="";for await(const v of he(o,{content:n,use_rag:!!_}))T+=v,u(T);t({type:"ADD_MESSAGE",payload:{chatId:o,item:{id:crypto.randomUUID(),chat_id:o,role:"assistant",content:T}}})}const B={state:a,loadChats:i,loadChatsIfAuthenticated:d,createChat:m,renameChat:x,deleteChat:h,removeChatLocal:y,restoreChatLocal:l,deleteChatApiOnly:c,updateChatTags:C,setCurrentChat:g,loadMessages:S,sendMessage:w,sendMessageStream:k};return e.jsx(L.Provider,{value:B,children:s})}function M(){const s=f.useContext(L);if(!s)throw new Error("useChat must be used within ChatProvider");return s}function fe({chatId:s,tags:a,onTagsChange:t}){const[r,i]=f.useState(a||[]),[d,m]=f.useState(!0),[x,h]=f.useState("");function y(){const c=x.trim();c&&(r.includes(c)||(i([...r,c]),h("")))}function l(c){i(r.filter(C=>C!==c))}return e.jsxs(R,{open:d,onClose:()=>m(!1),title:"Теги",footer:e.jsxs(e.Fragment,{children:[e.jsx(E,{variant:"ghost",onClick:()=>m(!1),children:"Закрыть"}),e.jsx(E,{onClick:()=>{t(r),m(!1)},children:"Сохранить"})]}),children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:8},children:[e.jsx($,{value:x,onChange:c=>h(c.target.value),placeholder:"Новый тег",onKeyDown:c=>{c.key==="Enter"&&y()}}),e.jsx(E,{onClick:y,children:"Добавить"})]}),e.jsxs("div",{style:{display:"flex",gap:6,flexWrap:"wrap"},children:[r.map(c=>e.jsxs("span",{style:{border:"1px solid rgba(255,255,255,.2)",padding:"2px 8px",borderRadius:999},children:[c," ",e.jsx("button",{onClick:()=>l(c),style:{marginLeft:6,opacity:.7},children:"×"})]},c)),r.length===0&&e.jsx("div",{style:{opacity:.7},children:"Пока пусто"})]})]})}function xe(s){let a=0;for(let t=0;t<s.length;t++)a=a*31+s.charCodeAt(t)>>>0;return a%360}function Ce(){return e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",children:[e.jsx("circle",{cx:"12",cy:"5",r:"2"}),e.jsx("circle",{cx:"12",cy:"12",r:"2"}),e.jsx("circle",{cx:"12",cy:"19",r:"2"})]})}function Se(){const{chatId:s}=D(),a=O(),{state:t,createChat:r,renameChat:i,updateChatTags:d,removeChatLocal:m,restoreChatLocal:x,deleteChatApiOnly:h}=M(),[y,l]=f.useState(null),[c,C]=f.useState(null),[g,S]=f.useState(null),[w,k]=f.useState(null),B=f.useMemo(()=>t.chatsOrder.map(n=>t.chatsById[n]),[t.chatsOrder,t.chatsById]);async function o(){const n=await r("Новый чат");a(`/gpt/chat/${n}`)}return e.jsxs("aside",{className:p.sidebar,children:[e.jsxs("div",{className:p.head,children:[e.jsx("div",{className:p.title,children:"Чаты"}),e.jsx(E,{size:"sm",onClick:o,children:"+ Новый"})]}),e.jsxs("div",{className:p.list,children:[B.length===0&&e.jsx("div",{className:p.item,style:{opacity:.7},children:"Нет чатов"}),B.map(n=>n&&e.jsxs("div",{className:[p.row,s===n.id?p.active:""].join(" "),children:[e.jsxs("button",{className:p.item,onClick:()=>a(`/gpt/chat/${n.id}`),children:[e.jsx("div",{className:p.name,children:n.name||"Без названия"}),Array.isArray(n.tags)&&n.tags.length>0&&e.jsx("div",{className:p.tags,children:n.tags.map(u=>{const _=xe(u),T=`hsla(${_}, 70%, 45%, .18)`,v=`hsla(${_}, 70%, 50%, .45)`,A=`hsla(${_}, 80%, 80%, .95)`;return e.jsx("span",{className:p.tag,style:{background:T,borderColor:v,color:A},children:u},u)})})]}),e.jsx(H,{trigger:e.jsx("button",{className:p.kebabBtn,"aria-label":"Меню",children:e.jsx(Ce,{})}),content:e.jsxs("div",{className:p.menu,children:[e.jsx("button",{className:p.item,onClick:()=>l({id:n.id,name:n.name||""}),children:"Переименовать"}),e.jsx("button",{className:p.item,onClick:()=>k({id:n.id,tags:n.tags||[]}),children:"Теги…"}),e.jsx("button",{className:p.item,onClick:()=>C({id:n.id,name:n.name||""}),children:"Удалить"})]}),align:"end"})]},n.id))]}),e.jsx(R,{open:!!y,onClose:()=>l(null),title:"Переименовать чат",footer:e.jsxs(e.Fragment,{children:[e.jsx(E,{variant:"ghost",onClick:()=>l(null),children:"Отмена"}),e.jsx(E,{onClick:async()=>{y&&(await i(y.id,y.name||"Без названия"),l(null))},children:"Сохранить"})]}),children:e.jsx($,{value:(y==null?void 0:y.name)||"",onChange:n=>l(u=>u&&{...u,name:n.target.value}),className:"w-100"})}),e.jsxs(R,{open:!!c,onClose:()=>C(null),title:"Удалить чат",footer:e.jsxs(e.Fragment,{children:[e.jsx(E,{variant:"ghost",onClick:()=>C(null),children:"Отмена"}),e.jsx(E,{variant:"danger",onClick:async()=>{if(!c)return;const n=t.chatsById[c.id],u=5;let _=u;m(c.id),s===c.id&&a("/gpt/chat"),C(null);const T=setTimeout(async()=>{try{await h((n==null?void 0:n.id)||"")}catch(A){console.error(A)}S(null)},u*1e3),v=setInterval(()=>{_-=1,S(A=>A&&{...A,secs:_})},1e3);S({id:(n==null?void 0:n.id)||"",name:(n==null?void 0:n.name)||"Без названия",tags:(n==null?void 0:n.tags)||[],secs:_,tid:T,iid:v})},children:"Удалить"})]}),children:["Вы уверены, что хотите удалить чат «",(c==null?void 0:c.name)||"Без названия","»?"]}),w&&e.jsx(fe,{chatId:w.id,tags:w.tags,onTagsChange:async n=>{await d(w.id,n),k(null)}}),g&&e.jsxs("div",{className:p.undoBar,role:"status",children:[e.jsxs("div",{className:p.undoText,children:["Чат «",g.name,"» удалён. Отменить можно в течение"," ",g.secs," с."]}),e.jsx("button",{className:p.undoBtn,onClick:()=>{clearTimeout(g.tid),clearInterval(g.iid),x({id:g.id,name:g.name||null,tags:g.tags||[]}),S(null)},children:"Отменить"})]})]})}const je="_main_1kdp0_1",Te="_card_1kdp0_9",ve="_history_1kdp0_17",Ee="_userMsg_1kdp0_26",we="_body_1kdp0_33",Ae="_assistantMsg_1kdp0_42",be="_composer_1kdp0_88",ke="_controls_1kdp0_112",Be="_actionsBottom_1kdp0_119",Ne="_ragToggle_1kdp0_126",j={main:je,card:Te,history:ve,userMsg:Ee,body:we,assistantMsg:Ae,composer:be,controls:ke,actionsBottom:Be,ragToggle:Ne},Re="_textarea_1mfsr_1",Me={textarea:Re},U=z.forwardRef((s,a)=>e.jsx("textarea",{...s,ref:a,className:[Me.textarea,s.className||""].join(" ")}));U.displayName="Textarea";function Ie({title:s,description:a,action:t}){return e.jsxs("div",{style:{display:"grid",placeItems:"center",minHeight:260,textAlign:"center",gap:8},children:[e.jsx("div",{style:{fontWeight:600,fontSize:18},children:s}),a&&e.jsx("div",{style:{opacity:.75},children:a}),t]})}function Pe(){const{chatId:s}=D(),a=O(),{state:t,loadMessages:r,setCurrentChat:i,sendMessageStream:d}=M(),[m,x]=f.useState(""),[h,y]=f.useState(!1),[l,c]=f.useState(!1),[C,g]=f.useState(""),S=f.useMemo(()=>s?t.messagesByChat[s]:void 0,[s,t.messagesByChat]),w=(S==null?void 0:S.items)||[];if(f.useEffect(()=>{var o;s&&(i(s),(o=t.messagesByChat[s])!=null&&o.loaded||r(s).catch(console.error),g(""))},[s]),!s)return e.jsx("div",{className:j.main,children:e.jsx(Ie,{title:"Выберите чат",description:"Слева — список ваших чатов. Создайте новый или откройте существующий.",action:e.jsx(E,{onClick:()=>a("/gpt/chat"),children:"Обновить"})})});async function k(){if(!m.trim())return;y(!0),g("");const o=m;x("");try{await d(s||"",o,n=>g(n),l)}catch(n){console.error(n)}finally{y(!1),g("")}}const B=!!s&&!!m.trim()&&!h;return e.jsx("div",{className:j.main,children:e.jsxs(G,{className:j.card,children:[e.jsxs("div",{className:j.history,children:[w.map(o=>e.jsx("div",{className:o.role==="user"?j.userMsg:j.assistantMsg,children:e.jsx("div",{className:j.body,children:o.content})},o.id)),C&&e.jsx("div",{className:j.assistantMsg,children:e.jsx("div",{className:j.body,children:C})}),w.length===0&&!t.isLoading&&e.jsx("div",{style:{opacity:.7},children:"Сообщений пока нет."})]}),e.jsxs("div",{className:j.composer,children:[e.jsx(U,{placeholder:"Ваше сообщение…",value:m,onChange:o=>x(o.target.value),disabled:!s||h,rows:3}),e.jsxs("div",{className:j.controls,children:[e.jsx("div",{}),e.jsxs("div",{className:j.actionsBottom,children:[e.jsx(E,{onClick:k,disabled:!B,children:"Отправить"}),e.jsxs("label",{className:j.ragToggle,title:"Использовать базу знаний (RAG) при ответе",children:[e.jsx("input",{type:"checkbox",checked:l,onChange:o=>c(o.target.checked)}),"RAG из БЗ"]})]})]})]})]})})}const De="_statusBar_ihgxn_1",Oe="_loading_ihgxn_9",$e="_error_ihgxn_22",Le="_spinner_ihgxn_32",N={statusBar:De,loading:Oe,error:$e,spinner:Le};function Ue(){const{state:s}=M(),{error:a,isLoading:t}=s;return!a&&!t?null:e.jsxs("div",{className:N.statusBar,children:[t&&e.jsxs("div",{className:N.loading,children:[e.jsx("div",{className:N.spinner}),"Загрузка..."]}),a&&e.jsxs("div",{className:N.error,children:["⚠️ ",a]})]})}function Qe(){return e.jsx(pe,{children:e.jsxs("div",{className:I.shell,children:[e.jsx(Se,{}),e.jsx("div",{className:I.main,children:e.jsx(Pe,{})}),e.jsx(Ue,{})]})})}export{Qe as default};
