const C=new TextEncoder,i={users:[{id:"u1",login:"admin",password:"admin",fio:"Администратор",role:"admin"}],chats:new Map,tokens:new Map,rag:[],analyze:[]};function f(e,u={}){return new Response(JSON.stringify(e),{status:200,headers:{"Content-Type":"application/json"},...u})}function R(){return new Response(null,{status:204})}function w(){return new Response("unauthorized",{status:401})}function T(){return new Response("not found",{status:404})}function z(e="bad request"){return new Response(e,{status:400})}function I(e){try{return new URL(e,window.location.origin)}catch{return new URL(window.location.origin+e.replace(/^\//,""))}}async function q(e){if(!e)return null;if(typeof e=="string")try{return JSON.parse(e)}catch{return null}return e instanceof FormData?e:null}function A(e){const u=e.get("Authorization")||"",c=u.startsWith("Bearer ")?u.slice(7):null;if(!c)return null;const s=i.tokens.get(c||"");return i.users.find(r=>r.id===s)||null}function G(e,u=40){return new ReadableStream({async start(c){for(const s of e){const o=`data: ${s}

`;c.enqueue(C.encode(o)),await new Promise(r=>setTimeout(r,u))}c.close()}})}function L(e,u,c=20){let s=0;if(u){const h=e.findIndex(g=>(g.id||g.chat_id)===u);s=h>=0?h+1:0}const o=e.slice(s,s+c),r=s+c<e.length?e[s+c-1].id:null;return{items:o,next_cursor:r}}function M(){if(i.rag.length>0)return;const e=new Date().toISOString();i.rag.push({id:"doc1",name:"Guide.pdf",status:"ready",tags:["guide"],created_at:e},{id:"doc2",name:"Spec.md",status:"processing",tags:["spec"],created_at:e},{id:"doc3",name:"Manual.txt",status:"uploaded",tags:["manual"],created_at:e})}function $(e){setTimeout(()=>{e.status="processing"},600),setTimeout(()=>{e.status="ready"},1400)}function v(e){setTimeout(()=>{e.status="processing"},500),setTimeout(()=>{e.status="done",e.result=`Результат анализа: «${e.source||"file"}» обработан.`},1500)}async function F(e,u={}){var _,y,S,k,U,E,P;const c=I(e),s=c.pathname,o=(u.method||"GET").toUpperCase(),r=await q(u.body||null);if(s==="/api/auth/login"&&o==="POST"){const{login:t,password:n}=r||{},a=i.users.find(l=>l.login===t&&l.password===n);if(!a)return z("invalid credentials");const d=crypto.randomUUID();return i.tokens.set(d,a.id),f({access_token:d,refresh_token:"refresh_"+a.id,expires_in:3600})}if(s==="/api/auth/refresh"&&o==="POST"){const{refresh_token:t}=r||{};if(!t||!String(t).startsWith("refresh_"))return w();const n=String(t).slice(8),a=i.users.find(l=>l.id===n);if(!a)return w();const d=crypto.randomUUID();return i.tokens.set(d,a.id),f({access_token:d,expires_in:3600})}if(s==="/api/auth/me"&&o==="GET"){const t=A(new Headers(u.headers||{}));if(!t)return w();const{password:n,...a}=t;return f(a)}if(s==="/api/auth/logout"&&o==="POST"){const t=new Headers(u.headers||{}).get("Authorization")||"",n=t.startsWith("Bearer ")?t.slice(7):"";return i.tokens.delete(n),R()}if(s==="/api/chats"&&o==="POST"){const t=crypto.randomUUID(),n=r&&r.name||"New chat";return i.chats.set(t,{id:t,name:n,messages:[]}),f({chat_id:t})}if(s==="/api/chats"&&o==="GET"){const t=Array.from(i.chats.values()).map(n=>({id:n.id,name:n.name}));return f({items:t,next_cursor:null})}const h=s.match(/^\/api\/chats\/([^/]+)(?:\/(messages))?$/);if(h){const t=h[1],n=h[2],a=i.chats.get(t||"");if(!a&&o!=="PATCH"&&o!=="DELETE")return T();if(!n&&o==="PATCH"){const d=(r==null?void 0:r.name)||"Untitled",l=i.chats.get(t||"");return l?(l.name=d,f({ok:!0})):T()}if(!n&&o==="DELETE")return i.chats.delete(t||""),R();if(n==="messages"&&o==="GET"){const d=a?a.messages:[];return f({items:d,next_cursor:null})}if(n==="messages"&&o==="POST"){const d=r||{},l=((y=(_=d.messages)==null?void 0:_[0])==null?void 0:y.content)||"";a&&a.messages.push({role:"user",content:l});const p=`Привет! Это моковый ответ на: "${l}".
Моки включены, бэкенд не требуется.`;if(d.response_stream){const m=Array.from(p),D=G(m,18),O=m.join("");a&&a.messages.push({role:"assistant",content:O});const x=new Headers({"Content-Type":"text/event-stream; charset=utf-8","Cache-Control":"no-cache",Connection:"keep-alive"});return new Response(D,{status:200,headers:x})}else return a&&a.messages.push({role:"assistant",content:p}),f({message:{role:"assistant",content:p}})}}if(s==="/api/rag"&&o==="GET"){M();const t=((S=c.searchParams.get("q"))==null?void 0:S.toLowerCase())||"",n=c.searchParams.get("status")||"",a=c.searchParams.get("cursor")||void 0;let d=i.rag.slice();t&&(d=d.filter(m=>m.name.toLowerCase().includes(t))),n&&(d=d.filter(m=>m.status===n));const{items:l,next_cursor:p}=L(d,a,20);return f({items:l,next_cursor:p})}if(s==="/api/rag/upload"&&o==="POST"){const t=r instanceof FormData&&(r.get("name")||((k=r.get("file"))==null?void 0:k.name))||"document",n={id:crypto.randomUUID(),name:t,status:"uploaded",tags:[],created_at:new Date().toISOString()};return i.rag.unshift(n),$(n),f({id:n.id,status:n.status})}if(s==="/api/rag/search"&&o==="POST"){const t=(r==null?void 0:r.text)||"";return f({items:[{document_id:((U=i.rag[0])==null?void 0:U.id)||"doc1",chunk_id:"1",score:.92,snippet:`Найдено по запросу "${t}" — фрагмент №1`},{document_id:((E=i.rag[0])==null?void 0:E.id)||"doc1",chunk_id:"2",score:.87,snippet:`Найдено по запросу "${t}" — фрагмент №2`}]})}if(s==="/api/analyze"&&o==="GET"){const t=i.analyze.slice().sort((n,a)=>a.created_at>n.created_at?1:-1);return f({items:t})}if(s==="/api/analyze"&&o==="POST"){let t="";if(r instanceof FormData?t=((P=r.get("file"))==null?void 0:P.name)||"file":t=(r==null?void 0:r.url)||"",!t)return z("source required");const n={id:crypto.randomUUID(),source:t,status:"queued",created_at:new Date().toISOString()};return i.analyze.unshift(n),v(n),f({id:n.id,status:n.status})}const g=s.match(/^\/api\/analyze\/([^/]+)$/);if(g&&o==="GET"){const t=g[1],n=i.analyze.find(a=>a.id===t);return n?f(n):T()}return fetch(e,u)}function H(e){if(typeof e=="string")return e;if(e instanceof URL)return e.toString();try{return e.url||String(e)}catch{return String(e)}}if(typeof window<"u"){const e=window.fetch.bind(window);window.fetch=(u,c)=>{const s=H(u);return c&&c.headers&&c.headers["X-Bypass-Mock"]?e(u,c):F(s,c)}}
