import{r,j as e}from"./index-BSRK8Mud.js";import{C as P}from"./Card-t3ohTNFI.js";import{I as C}from"./Input-CnXT9I6F.js";import{B as o}from"./Button-B53gfBvU.js";import{B as b,F as m,a as z,S as T}from"./FilePicker-CX2bUmax.js";import{M as W,P as q}from"./Popover-sU5hq9hZ.js";import{a as N}from"./http-BXh0eoWj.js";async function I(){return N("/analyze")}async function M(c){const i=new FormData;return i.set("file",c),N("/analyze/upload",{method:"POST",body:i})}const O="_wrap_upxmx_1",E="_card_upxmx_6",R="_header_upxmx_19",D="_title_upxmx_26",Q="_controls_upxmx_32",U="_search_upxmx_39",G="_tableWrap_upxmx_43",n={wrap:O,card:E,header:R,title:D,controls:Q,search:U,tableWrap:G};function $(){const[c,i]=r.useState([]),[k,v]=r.useState(!1),[d,S]=r.useState(""),[a,u]=r.useState({}),[h,j]=r.useState({open:!1}),[F,x]=r.useState(!1),[f,w]=r.useState(null);async function _(){const s=await I();i(s.items||[])}r.useEffect(()=>{let s=!1,t=1500;return(async()=>{for(;!s;){try{await _()}catch{}await new Promise(y=>setTimeout(y,t)),t=Math.min(t*2,1e4)}})(),()=>{s=!0}},[]);const g=r.useMemo(()=>(c||[]).filter(s=>{const t=((s.source||"")+" "+(s.result||"")+" "+(s.created_at||"")+" "+s.status).toLowerCase();return!(d.trim()&&!t.includes(d.toLowerCase())||a.source&&!(s.source||"").toLowerCase().includes((a.source||"").toLowerCase())||a.status&&s.status!==a.status||a.result&&!(s.result||"").toLowerCase().includes((a.result||"").toLowerCase())||a.created_at&&!(s.created_at||"").toLowerCase().includes((a.created_at||"").toLowerCase()))}),[c,d,a]);function p(s,t){const l=t.getBoundingClientRect();j({open:!0,col:s,anchor:{x:l.left,y:l.bottom+6}})}function L(){u({}),j({open:!1})}async function A(){if(f){v(!0);try{await M(f),x(!1),w(null),await _()}finally{v(!1)}}}const B=Object.values(a).some(Boolean);return e.jsxs("div",{className:n.wrap,children:[e.jsxs(P,{className:n.card,children:[e.jsxs("div",{className:n.header,children:[e.jsx("div",{className:n.title,children:"Анализ документов — задачи"}),e.jsxs("div",{className:n.controls,children:[e.jsx(C,{className:n.search,placeholder:"Поиск…",value:d,onChange:s=>S(s.target.value)}),B&&e.jsx(b,{onClick:L,children:"Сбросить фильтры"}),e.jsx(o,{onClick:()=>x(!0),children:"Добавить"})]})]}),e.jsx("div",{className:n.tableWrap,children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsxs("th",{children:["Источник ",e.jsx("button",{className:"icon",type:"button","aria-label":"Фильтр по источнику",onClick:s=>p("source",s.currentTarget),children:e.jsx(m,{})})]}),e.jsxs("th",{children:["Статус ",e.jsx("button",{className:"icon",type:"button","aria-label":"Фильтр по статусу",onClick:s=>p("status",s.currentTarget),children:e.jsx(m,{})})]}),e.jsxs("th",{children:["Результат ",e.jsx("button",{className:"icon",type:"button","aria-label":"Фильтр по результату",onClick:s=>p("result",s.currentTarget),children:e.jsx(m,{})})]}),e.jsxs("th",{children:["Создано ",e.jsx("button",{className:"icon",type:"button","aria-label":"Фильтр по дате создания",onClick:s=>p("created_at",s.currentTarget),children:e.jsx(m,{})})]})]})}),e.jsxs("tbody",{children:[g.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"muted",children:s.source||"—"}),e.jsx("td",{children:e.jsx(b,{tone:s.status==="done"?"success":s.status==="error"?"danger":s.status==="processing"?"warn":"neutral",children:s.status})}),e.jsx("td",{style:{maxWidth:480,whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"},children:s.result||"—"}),e.jsx("td",{className:"muted",children:s.created_at||"—"})]},s.id)),g.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"muted",children:"Нет записей"})})]})]})})]}),e.jsx(W,{open:F,onClose:()=>x(!1),title:"Новый анализ",footer:e.jsxs(e.Fragment,{children:[e.jsx(o,{variant:"ghost",onClick:()=>x(!1),children:"Отмена"}),e.jsx(o,{onClick:A,disabled:k||!f,children:"Запустить"})]}),children:e.jsx(z,{onFileSelected:w})}),e.jsx(q,{trigger:e.jsx("div",{}),content:e.jsxs("div",{className:"stack",style:{minWidth:260},children:[h.col==="status"?e.jsxs(T,{value:a.status||"",onChange:s=>u(t=>({...t,status:s.target.value||void 0})),children:[e.jsx("option",{value:"",children:"Любой"}),e.jsx("option",{value:"queued",children:"queued"}),e.jsx("option",{value:"processing",children:"processing"}),e.jsx("option",{value:"done",children:"done"}),e.jsx("option",{value:"error",children:"error"})]}):e.jsx(C,{placeholder:"Фильтр…",value:a[h.col]||"",onChange:s=>{const t=s.target.value,l=h.col;u(y=>({...y,[l]:(t||"").trim()||void 0}))}}),e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"space-between"},children:[e.jsx(o,{size:"sm",variant:"ghost",onClick:()=>{const s=h.col;u(t=>({...t,[s]:void 0}))},children:"Очистить"}),e.jsx(o,{size:"sm",onClick:()=>j({open:!1}),children:"Применить"})]})]}),align:"end"})]})}export{$ as default};
