import{r as l,j as e}from"./index-BSRK8Mud.js";import{C as q}from"./Card-t3ohTNFI.js";import{I as b}from"./Input-CnXT9I6F.js";import{B as c}from"./Button-B53gfBvU.js";import{B as z,F as w,D,R as U,A as J,T as Q,M as V,a as G,S as H}from"./FilePicker-CX2bUmax.js";import{P as I,M as K}from"./Popover-sU5hq9hZ.js";import{a as h}from"./http-BXh0eoWj.js";async function X(a={}){const n=new URLSearchParams;return a.page&&n.set("page",String(a.page)),a.size&&n.set("size",String(a.size)),a.status&&n.set("status",a.status),a.search&&n.set("search",a.search),h(`/rag/?${n.toString()}`)}async function Y(a,n,u){const o=new FormData;return o.set("file",a),n&&o.set("name",n),u!=null&&u.length&&o.set("tags",JSON.stringify(u)),h("/rag/upload",{method:"POST",body:o})}async function Z(a,n="original"){return h(`/rag/${a}/download?kind=${n}`)}async function ee(a){return h(`/rag/${a}/archive`,{method:"POST"})}async function se(a){return h(`/rag/${a}`,{method:"DELETE"})}async function te(a){return h(`/rag/${a}/reindex`,{method:"POST"})}const ae="_wrap_673gd_1",ne="_card_673gd_6",re="_header_673gd_19",ie="_title_673gd_26",le="_controls_673gd_32",ce="_search_673gd_38",oe="_tableWrap_673gd_42",d={wrap:ae,card:ne,header:re,title:ie,controls:le,search:ce,tableWrap:oe};function ye(){const[a,n]=l.useState([]),[u,o]=l.useState(!1),[g,F]=l.useState(""),[r,j]=l.useState({}),[m,C]=l.useState({open:!1}),[T,f]=l.useState(!1),[p,_]=l.useState(null),[S,k]=l.useState([]),[de,L]=l.useState(null),[ue,A]=l.useState(!1);async function x(){const s=await X({page:1,size:100});n(s.items||[])}l.useEffect(()=>{x()},[]);const N=l.useMemo(()=>(a||[]).filter(s=>{var i,v;const t=((s.name||"")+" "+(s.status||"")+" "+(s.created_at||"")+" "+(((i=s.tags)==null?void 0:i.join(" "))||"")).toLowerCase();return!(g.trim()&&!t.includes(g.toLowerCase())||r.name&&!(s.name||"").toLowerCase().includes((r.name||"").toLowerCase())||r.status&&s.status!==r.status||r.tags&&!(((v=s.tags)==null?void 0:v.join(" "))||"").toLowerCase().includes((r.tags||"").toLowerCase())||r.created_at&&!(s.created_at||"").toLowerCase().includes((r.created_at||"").toLowerCase()))}),[a,g,r]);function y(s,t){const i=t.getBoundingClientRect();C({open:!0,col:s,anchor:{x:i.left,y:i.bottom+6}})}function B(){j({}),C({open:!1})}async function O(){if(p){o(!0);try{await Y(p,p.name,S),f(!1),_(null),k([]),await x()}finally{o(!1)}}}const R=async(s,t="original")=>{try{const i=await Z(s.id,t);i.url&&window.open(i.url,"_blank")}catch(i){console.error("Download failed:",i)}},P=async s=>{try{await ee(s.id),await x()}catch(t){console.error("Archive failed:",t)}},M=async s=>{if(confirm("Удалить документ?"))try{await se(s.id),await x()}catch(t){console.error("Delete failed:",t)}},E=async s=>{if(confirm("Переиндексировать документ?"))try{await te(s.id),await x()}catch(t){console.error("Reindex failed:",t),alert("Ошибка переиндексации")}},W=s=>{switch(s){case"queued":return"В очереди";case"processing":return"Обработка";case"ready":return"Готов";case"error":return"Ошибка";case"archived":return"Архив";default:return s}},$=Object.values(r).some(Boolean);return e.jsxs("div",{className:d.wrap,children:[e.jsxs(q,{className:d.card,children:[e.jsxs("div",{className:d.header,children:[e.jsx("div",{className:d.title,children:"База знаний — документы"}),e.jsxs("div",{className:d.controls,children:[e.jsx(b,{className:d.search,placeholder:"Поиск…",value:g,onChange:s=>F(s.target.value)}),$&&e.jsx(z,{onClick:B,children:"Сбросить фильтры"}),e.jsx(c,{onClick:()=>f(!0),children:"Добавить"})]})]}),e.jsx("div",{className:d.tableWrap,children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsxs("th",{children:["Название ",e.jsx("button",{className:"icon",type:"button","aria-label":"Фильтр по названию",onClick:s=>y("name",s.currentTarget),children:e.jsx(w,{})})]}),e.jsxs("th",{children:["Статус ",e.jsx("button",{className:"icon",type:"button","aria-label":"Фильтр по статусу",onClick:s=>y("status",s.currentTarget),children:e.jsx(w,{})})]}),e.jsxs("th",{children:["Теги ",e.jsx("button",{className:"icon",type:"button","aria-label":"Фильтр по тегам",onClick:s=>y("tags",s.currentTarget),children:e.jsx(w,{})})]}),e.jsxs("th",{children:["Создано ",e.jsx("button",{className:"icon",type:"button","aria-label":"Фильтр по дате создания",onClick:s=>y("created_at",s.currentTarget),children:e.jsx(w,{})})]}),e.jsx("th",{children:"Действия"})]})}),e.jsxs("tbody",{children:[N.map(s=>{var t;return e.jsxs("tr",{children:[e.jsx("td",{className:"muted",children:s.name||"—"}),e.jsx("td",{children:e.jsx(z,{tone:s.status==="ready"?"success":s.status==="error"?"danger":s.status==="processing"?"warn":"neutral",children:W(s.status)})}),e.jsx("td",{children:((t=s.tags)==null?void 0:t.join(", "))||"—"}),e.jsx("td",{className:"muted",children:s.created_at||"—"}),e.jsx("td",{children:e.jsx(I,{trigger:e.jsx("button",{className:"icon",type:"button","aria-label":"Действия",onClick:()=>{L(s),A(!0)},children:e.jsx(V,{})}),content:e.jsxs("div",{className:"stack",style:{minWidth:180},children:[s.status==="ready"&&e.jsxs(e.Fragment,{children:[e.jsxs(c,{size:"sm",variant:"ghost",onClick:()=>R(s,"original"),children:[e.jsx("span",{style:{marginRight:6,display:"inline-flex",alignItems:"center"},children:e.jsx(D,{size:12})}),"Скачать документ"]}),s.url_canonical_file&&e.jsxs(c,{size:"sm",variant:"ghost",onClick:()=>R(s,"canonical"),children:[e.jsx("span",{style:{marginRight:6,display:"inline-flex",alignItems:"center"},children:e.jsx(D,{size:12})}),"Скачать канонический вид"]}),e.jsxs(c,{size:"sm",variant:"ghost",onClick:()=>E(s),children:[e.jsx("span",{style:{marginRight:6,display:"inline-flex",alignItems:"center"},children:e.jsx(U,{size:12})}),"Пересчитать"]}),e.jsxs(c,{size:"sm",variant:"ghost",onClick:()=>P(s),children:[e.jsx("span",{style:{marginRight:6,display:"inline-flex",alignItems:"center"},children:e.jsx(J,{size:12})}),"Заархивировать"]})]}),e.jsxs(c,{size:"sm",variant:"ghost",onClick:()=>M(s),children:[e.jsx("span",{style:{marginRight:6,display:"inline-flex",alignItems:"center"},children:e.jsx(Q,{size:12})}),"Удалить"]})]}),align:"end"})})]},s.id)}),N.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"muted",children:"Нет записей"})})]})]})})]}),e.jsx(K,{open:T,onClose:()=>f(!1),title:"Новый документ",footer:e.jsxs(e.Fragment,{children:[e.jsx(c,{variant:"ghost",onClick:()=>f(!1),children:"Отмена"}),e.jsx(c,{onClick:O,disabled:u||!p,children:"Загрузить"})]}),children:e.jsxs("div",{className:"stack",children:[e.jsx(G,{onFileSelected:_,accept:".txt,.pdf,.doc,.docx,.md,.rtf,.odt"}),e.jsxs("div",{children:[e.jsx("label",{children:"Теги (опционально):"}),e.jsx(b,{placeholder:"Введите теги через запятую...",value:S.join(", "),onChange:s=>k(s.target.value.split(",").map(t=>t.trim()).filter(Boolean))})]})]})}),e.jsx(I,{trigger:e.jsx("div",{}),content:e.jsxs("div",{className:"stack",style:{minWidth:260},children:[m.col==="status"?e.jsxs(H,{value:r.status||"",onChange:s=>j(t=>({...t,status:s.target.value||void 0})),children:[e.jsx("option",{value:"",children:"Любой"}),e.jsx("option",{value:"queued",children:"В очереди"}),e.jsx("option",{value:"processing",children:"Обработка"}),e.jsx("option",{value:"ready",children:"Готов"}),e.jsx("option",{value:"error",children:"Ошибка"}),e.jsx("option",{value:"archived",children:"Архив"})]}):e.jsx(b,{placeholder:"Фильтр…",value:r[m.col]||"",onChange:s=>{const t=s.target.value,i=m.col;j(v=>({...v,[i]:(t||"").trim()||void 0}))}}),e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"space-between"},children:[e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>{const s=m.col;j(t=>({...t,[s]:void 0}))},children:"Очистить"}),e.jsx(c,{size:"sm",onClick:()=>C({open:!1}),children:"Применить"})]})]}),align:"end"})]})}export{ye as default};
