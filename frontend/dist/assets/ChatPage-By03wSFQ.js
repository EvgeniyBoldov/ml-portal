import{r as p,j as e,a as O,u as $,R as G}from"./index-BSRK8Mud.js";import{B as E}from"./Button-B53gfBvU.js";import{M,P as q}from"./Popover-sU5hq9hZ.js";import{I as L}from"./Input-CnXT9I6F.js";import{a as N}from"./http-BXh0eoWj.js";import{C as z}from"./Card-t3ohTNFI.js";const J="_shell_sodz2_1",F="_main_sodz2_12",P={shell:J,main:F},K="_sidebar_1tmat_1",W="_head_1tmat_13",Q="_title_1tmat_14",V="_list_1tmat_15",X="_row_1tmat_23",Y="_kebabBtn_1tmat_35",Z="_active_1tmat_36",ee="_item_1tmat_37",te="_name_1tmat_54",se="_tags_1tmat_63",ae="_tag_1tmat_63",ne="_menu_1tmat_96",oe="_undoBar_1tmat_122",re="_undoText_1tmat_130",ie="_undoBtn_1tmat_131",_={sidebar:K,head:W,title:Q,list:V,row:X,kebabBtn:Y,active:Z,item:ee,name:te,tags:se,tag:ae,menu:ne,undoBar:oe,undoText:re,undoBtn:ie};async function*ce(t){const a=t.getReader(),s=new TextDecoder;let r="";try{for(;;){const{value:i,done:h}=await a.read();if(h)break;r+=s.decode(i,{stream:!0});let g;for(;(g=r.indexOf(`

`))!==-1;){const f=r.slice(0,g).trim();if(r=r.slice(g+2),!f)continue;const m={};for(const S of f.split(`
`)){const[d,...c]=S.split(":"),y=c.join(":").trimStart();d==="event"?m.event=y:d==="data"?m.data=(m.data?m.data+`
`:"")+y:d==="id"&&(m.id=y)}yield m}}}finally{a.releaseLock()}}async function le(t={}){const a=new URLSearchParams;return t.limit&&a.set("limit",String(t.limit)),t.cursor&&a.set("cursor",t.cursor),t.q&&a.set("q",t.q),N(`/chats?${a.toString()}`)}async function de(t,a){return N("/chats",{method:"POST",body:JSON.stringify({name:t??null,tags:a??null})})}async function ue(t,a={}){const s=new URLSearchParams;return a.limit&&s.set("limit",String(a.limit)),a.cursor&&s.set("cursor",a.cursor),N(`/chats/${t}/messages?${s.toString()}`)}async function he(t,a){return N(`/chats/${t}/messages`,{method:"POST",body:JSON.stringify(a),idempotent:!0})}async function*me(t,a){var f;const s={"Content-Type":"application/json"},r=((f=window.__auth_tokens)==null?void 0:f.access_token)||localStorage.getItem("access_token");r&&(s.Authorization=`Bearer ${r}`);const h=await fetch(`/api/chats/${t}/messages`,{method:"POST",headers:s,body:JSON.stringify({...a,response_stream:!0})});if(!h.ok)throw new Error(`HTTP ${h.status}`);if((h.headers.get("content-type")||"").includes("text/event-stream"))for await(const m of ce(h.body))m.data&&(yield m.data);else{const m=h.body.getReader(),S=new TextDecoder;let d="";for(;;){const{value:c,done:y}=await m.read();if(y)break;d+=S.decode(c,{stream:!0});let j;for(;(j=d.indexOf(`
`))!==-1;){const x=d.slice(0,j).trim();d=d.slice(j+1),x&&(yield x)}}d.trim()&&(yield d.trim())}}async function ye(t,a){const s={name:a};return N(`/chats/${t}`,{method:"PATCH",body:JSON.stringify(s)})}async function ge(t,a){const s={tags:a};return N(`/chats/${t}/tags`,{method:"PUT",body:JSON.stringify(s)})}async function D(t){return N(`/chats/${t}`,{method:"DELETE"})}const _e={isLoading:!1,error:null,chatsOrder:[],chatsById:{},messagesByChat:{},currentChatId:null};function pe(t,a){switch(a.type){case"SET_LOADING":return{...t,isLoading:a.payload};case"SET_ERROR":return{...t,error:a.payload};case"SET_CURRENT_CHAT":return{...t,currentChatId:a.payload};case"SET_CHATS":{const s={},r=[];for(const i of a.payload)s[i.id]=i,r.push(i.id);return{...t,chatsById:s,chatsOrder:r}}case"UPSERT_CHAT":{const s=a.payload.id,r=!!t.chatsById[s],i={...t.chatsById,[s]:{...t.chatsById[s],...a.payload}},h=r?t.chatsOrder:[s,...t.chatsOrder];return{...t,chatsById:i,chatsOrder:h}}case"DELETE_CHAT":{const{[a.payload]:s,...r}=t.chatsById;return{...t,chatsById:r,chatsOrder:t.chatsOrder.filter(i=>i!==a.payload)}}case"SET_MESSAGES":{const{chatId:s,items:r,nextCursor:i,hasMore:h}=a.payload,g={...t.messagesByChat,[s]:{items:r,nextCursor:i,hasMore:h,loaded:!0}};return{...t,messagesByChat:g}}case"APPEND_MESSAGES":{const{chatId:s,items:r,nextCursor:i,hasMore:h}=a.payload,f=[...(t.messagesByChat[s]||{items:[]}).items,...r];return{...t,messagesByChat:{...t.messagesByChat,[s]:{items:f,nextCursor:i,hasMore:h,loaded:!0}}}}case"ADD_MESSAGE":{const{chatId:s,item:r}=a.payload,i=t.messagesByChat[s]||{items:[],nextCursor:null,hasMore:!1,loaded:!1};return{...t,messagesByChat:{...t.messagesByChat,[s]:{...i,items:[...i.items,r],loaded:!0}}}}case"UPDATE_CHAT_PARTIAL":{const{chatId:s,patch:r}=a.payload,i=t.chatsById[s];return i?{...t,chatsById:{...t.chatsById,[s]:{...i,...r}}}:t}}}const U=p.createContext(void 0);function fe({children:t}){const[a,s]=p.useReducer(pe,_e),r=p.useRef(!1);async function i(){s({type:"SET_LOADING",payload:!0});try{const n=await le({limit:100});s({type:"SET_CHATS",payload:n.items}),s({type:"SET_ERROR",payload:null})}catch(n){s({type:"SET_ERROR",payload:(n==null?void 0:n.message)||"failed_to_load_chats"})}finally{s({type:"SET_LOADING",payload:!1})}}async function h(){var l;(((l=window.__auth_tokens)==null?void 0:l.access_token)||localStorage.getItem("access_token"))&&await i()}p.useEffect(()=>{r.current||(r.current=!0,h())},[]);async function g(n,l){const u=(await de(n??null,l??null)).chat_id;return s({type:"UPSERT_CHAT",payload:{id:u,name:n??null,tags:l??null}}),u}async function f(n,l){await ye(n,l),s({type:"UPDATE_CHAT_PARTIAL",payload:{chatId:n,patch:{name:l}}})}async function m(n){await D(n),s({type:"DELETE_CHAT",payload:n}),a.currentChatId===n&&s({type:"SET_CURRENT_CHAT",payload:null})}function S(n){s({type:"DELETE_CHAT",payload:n}),a.currentChatId===n&&s({type:"SET_CURRENT_CHAT",payload:null})}function d(n){s({type:"UPSERT_CHAT",payload:n})}async function c(n){await D(n)}async function y(n,l){await ge(n,l),s({type:"UPDATE_CHAT_PARTIAL",payload:{chatId:n,patch:{tags:l}}})}function j(n){s({type:"SET_CURRENT_CHAT",payload:n})}async function x(n,l){const o=a.messagesByChat[n];if(!l&&(o!=null&&o.loaded))return;const u=await ue(n,l?{cursor:(o==null?void 0:o.nextCursor)||void 0}:{}),C=u.items,v=u.next_cursor??null,k=!!v&&C.length>0;s({type:l?"APPEND_MESSAGES":"SET_MESSAGES",payload:{chatId:n,items:C,nextCursor:v,hasMore:k}})}async function A(n,l,o){const u=await he(n,{content:l,use_rag:!!o}),C={id:u.message_id,chat_id:n,role:"user",content:l};s({type:"ADD_MESSAGE",payload:{chatId:n,item:C}});const v={id:crypto.randomUUID(),chat_id:n,role:"assistant",content:u.answer};return s({type:"ADD_MESSAGE",payload:{chatId:n,item:v}}),u.message_id}async function b(n,l,o,u){s({type:"ADD_MESSAGE",payload:{chatId:n,item:{id:crypto.randomUUID(),chat_id:n,role:"user",content:l}}});let C="";for await(const v of me(n,{content:l,use_rag:!!u}))C+=v,o(C);s({type:"ADD_MESSAGE",payload:{chatId:n,item:{id:crypto.randomUUID(),chat_id:n,role:"assistant",content:C}}})}const w={state:a,loadChats:i,loadChatsIfAuthenticated:h,createChat:g,renameChat:f,deleteChat:m,removeChatLocal:S,restoreChatLocal:d,deleteChatApiOnly:c,updateChatTags:y,setCurrentChat:j,loadMessages:x,sendMessage:A,sendMessageStream:b};return e.jsx(U.Provider,{value:w,children:t})}function I(){const t=p.useContext(U);if(!t)throw new Error("useChat must be used within ChatProvider");return t}function xe({chatId:t,tags:a,onTagsChange:s}){const[r,i]=p.useState(a||[]),[h,g]=p.useState(!0),[f,m]=p.useState("");function S(){const c=f.trim();c&&(r.includes(c)||(i([...r,c]),m("")))}function d(c){i(r.filter(y=>y!==c))}return e.jsxs(M,{open:h,onClose:()=>g(!1),title:"Теги",footer:e.jsxs(e.Fragment,{children:[e.jsx(E,{variant:"ghost",onClick:()=>g(!1),children:"Закрыть"}),e.jsx(E,{onClick:()=>{s(r),g(!1)},children:"Сохранить"})]}),children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:8},children:[e.jsx(L,{value:f,onChange:c=>m(c.target.value),placeholder:"Новый тег",onKeyDown:c=>{c.key==="Enter"&&S()}}),e.jsx(E,{onClick:S,children:"Добавить"})]}),e.jsxs("div",{style:{display:"flex",gap:6,flexWrap:"wrap"},children:[r.map(c=>e.jsxs("span",{style:{border:"1px solid rgba(255,255,255,.2)",padding:"2px 8px",borderRadius:999},children:[c," ",e.jsx("button",{onClick:()=>d(c),style:{marginLeft:6,opacity:.7},children:"×"})]},c)),r.length===0&&e.jsx("div",{style:{opacity:.7},children:"Пока пусто"})]})]})}function Ce(t){let a=0;for(let s=0;s<t.length;s++)a=a*31+t.charCodeAt(s)>>>0;return a%360}function je(){return e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",children:[e.jsx("circle",{cx:"12",cy:"5",r:"2"}),e.jsx("circle",{cx:"12",cy:"12",r:"2"}),e.jsx("circle",{cx:"12",cy:"19",r:"2"})]})}function Se(){const{chatId:t}=O(),a=$(),{state:s,createChat:r,renameChat:i,deleteChat:h,updateChatTags:g,removeChatLocal:f,restoreChatLocal:m,deleteChatApiOnly:S}=I(),[d,c]=p.useState(null),[y,j]=p.useState(null),[x,A]=p.useState(null),[b,w]=p.useState(null),n=p.useMemo(()=>s.chatsOrder.map(o=>s.chatsById[o]),[s.chatsOrder,s.chatsById]);async function l(){const o=await r("Новый чат");a(`/gpt/chat/${o}`)}return e.jsxs("aside",{className:_.sidebar,children:[e.jsxs("div",{className:_.head,children:[e.jsx("div",{className:_.title,children:"Чаты"}),e.jsx(E,{size:"sm",onClick:l,children:"+ Новый"})]}),e.jsxs("div",{className:_.list,children:[n.length===0&&e.jsx("div",{className:_.item,style:{opacity:.7},children:"Нет чатов"}),n.map(o=>e.jsxs("div",{className:[_.row,t===o.id?_.active:""].join(" "),children:[e.jsxs("button",{className:_.item,onClick:()=>a(`/gpt/chat/${o.id}`),children:[e.jsx("div",{className:_.name,children:o.name||"Без названия"}),Array.isArray(o.tags)&&o.tags.length>0&&e.jsx("div",{className:_.tags,children:o.tags.map(u=>{const C=Ce(u),v=`hsla(${C}, 70%, 45%, .18)`,k=`hsla(${C}, 70%, 50%, .45)`,B=`hsla(${C}, 80%, 80%, .95)`;return e.jsx("span",{className:_.tag,style:{background:v,borderColor:k,color:B},children:u},u)})})]}),e.jsx(q,{trigger:e.jsx("button",{className:_.kebabBtn,"aria-label":"Меню",children:e.jsx(je,{})}),content:e.jsxs("div",{className:_.menu,children:[e.jsx("button",{className:_.item,onClick:()=>c({id:o.id,name:o.name||""}),children:"Переименовать"}),e.jsx("button",{className:_.item,onClick:()=>w({id:o.id,tags:o.tags||[]}),children:"Теги…"}),e.jsx("button",{className:_.item,onClick:()=>j({id:o.id,name:o.name||""}),children:"Удалить"})]}),align:"end"})]},o.id))]}),e.jsx(M,{open:!!d,onClose:()=>c(null),title:"Переименовать чат",footer:e.jsxs(e.Fragment,{children:[e.jsx(E,{variant:"ghost",onClick:()=>c(null),children:"Отмена"}),e.jsx(E,{onClick:async()=>{d&&(await i(d.id,d.name||"Без названия"),c(null))},children:"Сохранить"})]}),children:e.jsx(L,{value:(d==null?void 0:d.name)||"",onChange:o=>c(u=>u&&{...u,name:o.target.value}),className:"w-100"})}),e.jsxs(M,{open:!!y,onClose:()=>j(null),title:"Удалить чат",footer:e.jsxs(e.Fragment,{children:[e.jsx(E,{variant:"ghost",onClick:()=>j(null),children:"Отмена"}),e.jsx(E,{variant:"danger",onClick:async()=>{if(!y)return;const o=s.chatsById[y.id],u=5;let C=u;f(y.id),t===y.id&&a("/gpt/chat"),j(null);const v=setTimeout(async()=>{try{await S(o.id)}catch(B){console.error(B)}A(null)},u*1e3),k=setInterval(()=>{C-=1,A(B=>B&&{...B,secs:C})},1e3);A({id:o.id,name:(o==null?void 0:o.name)||"Без названия",tags:(o==null?void 0:o.tags)||[],secs:C,tid:v,iid:k})},children:"Удалить"})]}),children:["Вы уверены, что хотите удалить чат «",(y==null?void 0:y.name)||"Без названия","»?"]}),b&&e.jsx(xe,{chatId:b.id,tags:b.tags,onTagsChange:async o=>{await g(b.id,o),w(null)}}),x&&e.jsxs("div",{className:_.undoBar,role:"status",children:[e.jsxs("div",{className:_.undoText,children:["Чат «",x.name,"» удалён. Отменить можно в течение ",x.secs," с."]}),e.jsx("button",{className:_.undoBtn,onClick:()=>{clearTimeout(x.tid),clearInterval(x.iid),m({id:x.id,name:x.name||null,tags:x.tags||[]}),A(null)},children:"Отменить"})]})]})}const Te="_main_14pg0_1",ve="_card_14pg0_9",Ee="_history_14pg0_17",Ae="_userMsg_14pg0_26",be="_body_14pg0_33",Be="_assistantMsg_14pg0_42",Ne="_composer_14pg0_88",we="_controls_14pg0_109",ke="_actionsBottom_14pg0_110",Re="_ragToggle_14pg0_111",T={main:Te,card:ve,history:Ee,userMsg:Ae,body:be,assistantMsg:Be,composer:Ne,controls:we,actionsBottom:ke,ragToggle:Re},Me="_textarea_78mx9_1",Ie={textarea:Me},H=G.forwardRef((t,a)=>e.jsx("textarea",{...t,ref:a,className:[Ie.textarea,t.className||""].join(" ")}));H.displayName="Textarea";function Pe({title:t,description:a,action:s}){return e.jsxs("div",{style:{display:"grid",placeItems:"center",minHeight:260,textAlign:"center",gap:8},children:[e.jsx("div",{style:{fontWeight:600,fontSize:18},children:t}),a&&e.jsx("div",{style:{opacity:.75},children:a}),s]})}function De(){const{chatId:t}=O(),a=$(),{state:s,loadMessages:r,setCurrentChat:i,sendMessageStream:h}=I(),[g,f]=p.useState(""),[m,S]=p.useState(!1),[d,c]=p.useState(!1),[y,j]=p.useState(""),x=p.useMemo(()=>t?s.messagesByChat[t]:void 0,[t,s.messagesByChat]),A=(x==null?void 0:x.items)||[];if(p.useEffect(()=>{var n;t&&(i(t),(n=s.messagesByChat[t])!=null&&n.loaded||r(t).catch(console.error),j(""))},[t]),!t)return e.jsx("div",{className:T.main,children:e.jsx(Pe,{title:"Выберите чат",description:"Слева — список ваших чатов. Создайте новый или откройте существующий.",action:e.jsx(E,{onClick:()=>a("/gpt/chat"),children:"Обновить"})})});async function b(){if(!g.trim())return;S(!0),j("");const n=g;f("");try{await h(t,n,l=>j(l),d)}catch(l){console.error(l)}finally{S(!1),j("")}}const w=!!t&&!!g.trim()&&!m;return e.jsx("div",{className:T.main,children:e.jsxs(z,{className:T.card,children:[e.jsxs("div",{className:T.history,children:[A.map(n=>e.jsx("div",{className:n.role==="user"?T.userMsg:T.assistantMsg,children:e.jsx("div",{className:T.body,children:n.content})},n.id)),y&&e.jsx("div",{className:T.assistantMsg,children:e.jsx("div",{className:T.body,children:y})}),A.length===0&&!s.isLoading&&e.jsx("div",{style:{opacity:.7},children:"Сообщений пока нет."})]}),e.jsxs("div",{className:T.composer,children:[e.jsx(H,{placeholder:"Ваше сообщение…",value:g,onChange:n=>f(n.target.value),disabled:!t||m,rows:3}),e.jsxs("div",{className:T.controls,children:[e.jsx("div",{}),e.jsxs("div",{className:T.actionsBottom,children:[e.jsx(E,{onClick:b,disabled:!w,children:"Отправить"}),e.jsxs("label",{className:T.ragToggle,title:"Использовать базу знаний (RAG) при ответе",children:[e.jsx("input",{type:"checkbox",checked:d,onChange:n=>c(n.target.checked)}),"RAG из БЗ"]})]})]})]})]})})}const Oe="_statusBar_1jurm_1",$e="_loading_1jurm_9",Le="_error_1jurm_22",Ue="_spinner_1jurm_32",R={statusBar:Oe,loading:$e,error:Le,spinner:Ue};function He(){const{state:t}=I(),{error:a,isLoading:s}=t;return!a&&!s?null:e.jsxs("div",{className:R.statusBar,children:[s&&e.jsxs("div",{className:R.loading,children:[e.jsx("div",{className:R.spinner}),"Загрузка..."]}),a&&e.jsxs("div",{className:R.error,children:["⚠️ ",a]})]})}function We(){return e.jsx(fe,{children:e.jsxs("div",{className:P.shell,children:[e.jsx(Se,{}),e.jsx("div",{className:P.main,children:e.jsx(De,{})}),e.jsx(He,{})]})})}export{We as default};
