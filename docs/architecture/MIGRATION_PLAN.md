# План миграции ML Portal

## Цель
Провести системный рефакторинг бэкенда с поэтапной миграцией компонентов, тестированием на каждом этапе и созданием реестра компонентов.

## Принципы миграции
1. **Поэтапность** - мигрируем по одному компоненту за раз
2. **Тестирование** - после каждого этапа пишем и прогоняем тесты
3. **Реестр** - ведем документацию всех компонентов
4. **Зависимости** - мигрируем в порядке зависимостей (сначала базовые, потом зависимые)

## Этапы миграции

### Этап 1: Базовые коннекторы и утилиты
**Цель**: Создать надежную основу для всех остальных компонентов

#### 1.1 Конфигурация и настройки
- [ ] `apps/api/src/app/core/config.py` - настройки приложения
- [ ] `apps/api/src/app/core/env.py` - переменные окружения
- [ ] `apps/api/src/app/core/settings.py` - конфигурация сервисов

#### 1.2 База данных
- [ ] `apps/api/src/app/core/db.py` - подключение к БД
- [ ] `apps/api/src/app/migrations/` - миграции Alembic

#### 1.3 Кэш и Redis
- [ ] `apps/api/src/app/core/cache.py` - кэширование
- [ ] `apps/api/src/app/core/redis.py` - Redis подключение

#### 1.4 S3 и файловое хранилище
- [ ] `apps/api/src/app/core/s3.py` - S3 клиент
- [ ] `apps/api/src/app/storage/` - файловые операции

#### 1.5 Логирование и мониторинг
- [ ] `apps/api/src/app/core/logging.py` - логирование
- [ ] `apps/api/src/app/core/metrics.py` - метрики

**Критерии готовности**: Все тесты коннекторов проходят, компоненты изолированы и переиспользуемы.

### Этап 2: Модели данных
**Цель**: Создать чистые, типизированные модели

#### 2.1 Базовые модели
- [x] `apps/api/src/app/models/base.py` - базовая модель
- [x] `apps/api/src/app/models/__init__.py` - экспорты

#### 2.2 Модели пользователей
- [x] `apps/api/src/app/models/user.py` - пользователи, токены, аудит

#### 2.3 Модели чатов
- [x] `apps/api/src/app/models/chat.py` - чаты и сообщения

#### 2.4 RAG модели
- [x] `apps/api/src/app/models/rag.py` - документы и чанки

#### 2.5 Модели анализа
- [x] `apps/api/src/app/models/analyze.py` - анализ документов

**Критерии готовности**: Все модели проходят валидацию, миграции работают, тесты моделей проходят.

### Этап 3: Репозитории (Data Access Layer)
**Цель**: Создать слой доступа к данным

#### 3.1 Базовый репозиторий
- [ ] `apps/api/src/app/repositories/_base.py` - базовый CRUD

#### 3.2 Репозитории пользователей
- [ ] `apps/api/src/app/repositories/users_repo.py` - пользователи
- [ ] `apps/api/src/app/repositories/users_repo_sync.py` - синхронная версия

#### 3.3 Репозитории чатов
- [ ] `apps/api/src/app/repositories/chats_repo.py` - чаты
- [ ] `apps/api/src/app/repositories/chats_repo_sync.py` - синхронная версия

#### 3.4 RAG репозитории
- [ ] `apps/api/src/app/repositories/rag_repo.py` - RAG документы

**Критерии готовности**: Все репозитории протестированы, CRUD операции работают.

### Этап 4: Сервисы (Business Logic Layer)
**Цель**: Создать бизнес-логику приложения

#### 4.1 Базовые сервисы
- [ ] `apps/api/src/app/services/_base.py` - базовый сервис

#### 4.2 Сервисы аутентификации
- [ ] `apps/api/src/app/services/auth_service.py` - аутентификация
- [ ] `apps/api/src/app/services/admin_service.py` - админка

#### 4.3 Сервисы пользователей
- [ ] `apps/api/src/app/services/users_service.py` - управление пользователями

#### 4.4 Сервисы чатов
- [ ] `apps/api/src/app/services/chats_service.py` - чаты

#### 4.5 RAG сервисы
- [ ] `apps/api/src/app/services/rag_service.py` - RAG функциональность

#### 4.6 Утилитарные сервисы
- [ ] `apps/api/src/app/services/text_normalizer.py` - нормализация текста
- [ ] `apps/api/src/app/services/audit_service.py` - аудит

**Критерии готовности**: Все сервисы протестированы, бизнес-логика работает.

### Этап 5: API слой
**Цель**: Создать REST API

#### 5.1 Базовые компоненты API
- [ ] `apps/api/src/app/api/deps.py` - зависимости
- [ ] `apps/api/src/app/api/middleware/` - middleware
- [ ] `apps/api/src/app/core/security.py` - безопасность

#### 5.2 Роутеры
- [ ] `apps/api/src/app/api/routers/auth.py` - аутентификация
- [ ] `apps/api/src/app/api/routers/admin.py` - админка
- [ ] `apps/api/src/app/api/routers/chats.py` - чаты
- [ ] `apps/api/src/app/api/routers/rag.py` - RAG
- [ ] `apps/api/src/app/api/routers/analyze.py` - анализ

#### 5.3 Схемы данных
- [ ] `apps/api/src/app/schemas/` - Pydantic схемы

**Критерии готовности**: API работает, все эндпоинты протестированы.

### Этап 6: Фоновые задачи
**Цель**: Создать систему фоновых задач

#### 6.1 Celery настройка
- [ ] `apps/api/src/app/celery_app.py` - Celery приложение

#### 6.2 Задачи
- [ ] `apps/api/src/app/tasks/bg_tasks.py` - фоновые задачи

**Критерии готовности**: Фоновые задачи работают, очереди настроены.

### Этап 7: Интеграция и тестирование
**Цель**: Интегрировать все компоненты

#### 7.1 Главное приложение
- [ ] `apps/api/src/app/main.py` - FastAPI приложение

#### 7.2 Интеграционные тесты
- [ ] `apps/api/tests/` - полное тестирование

#### 7.3 Документация
- [ ] Обновить API документацию
- [ ] Обновить README

**Критерии готовности**: Все тесты проходят, приложение работает в продакшене.

## Контрольные точки

После каждого этапа:
1. ✅ Все тесты проходят
2. ✅ Компонент добавлен в реестр
3. ✅ Документация обновлена
4. ✅ Код проходит линтеры
5. ✅ Нет критических зависимостей

## Откат

В случае проблем на любом этапе:
1. Возвращаемся к предыдущему рабочему состоянию
2. Анализируем проблему
3. Исправляем и повторяем этап

## Временные рамки

- **Этап 1**: 2-3 дня
- **Этап 2**: 1-2 дня  
- **Этап 3**: 2-3 дня
- **Этап 4**: 3-4 дня
- **Этап 5**: 2-3 дня
- **Этап 6**: 1-2 дня
- **Этап 7**: 2-3 дня

**Общее время**: 13-20 дней
