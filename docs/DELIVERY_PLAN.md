# ML-Portal — План доводки до ТЗ (с верхнеуровневым описанием)

> **Контекст ТЗ**: портал‑консультант по базе знаний компании. MVP для 5 пользователей (таргет 100–200), ~100 LLM‑запросов/час (в т.ч. 5–10 анализ дока по RAG, 20–30 чат+RAG), мульти‑тенантность, локальные HF‑модели (прод без интернета), все тесты — в контейнере.

---

## 0. Преамбула и рамки
**Зачем**: зафиксировать цели релиза, ограничения и роли.  
**Функции**: KPI MVP, ограничения среды (офлайн модели, ресурсы), зоны ответственности (TL/архитектор, BE, FE, MLOps, QA).  
**Связь с ТЗ**: превращает видение в границы v1 (чат/RAG/ингест/анализ), исключая лишнее.

---

## 1. Правка ручек (HTTP/API слой)
**Зачем**: единый и предсказуемый входной интерфейс, без дублей и разнобоя.  
**Функции**: routers‑only, стандартизация ошибок, покрытие сценариев ТЗ: классический чат (sync/stream), RAG‑чат (sync/stream), ingest источников/доков, анализ документа, админ/RBAC/тенанты, каталог моделей.  
**Связь с ТЗ**: это “лицо” системы; без стабильных ручек FE и e2e тесты ломаются.

---

## 2. Правка коннекторов (LLM/Embeddings/Storage/Index)
**Зачем**: стабильные абстракции для локальных LLM/эмбеддингов/артефактов, независимые от конкретных либ.  
**Функции**: `LLMClient / EmbClient / ArtifactStore / VectorIndex`; несколько моделей и версий; таймауты/ретраи; приоритет stream/non‑stream.  
**Связь с ТЗ**: даёт переключаемость моделей/версий и офлайн‑режим HF на проде.

---

## 3. Правка моделей (доменные и ML)
**Зачем**: единый словарь сущностей и типов.  
**Функции**: DTO: User/Tenant/Project/Roles, Provider/Model/Version, Job/Task, Document/Source, Artifact; статусы; идемпотентность.  
**Связь с ТЗ**: корректная мульти‑тенантность и совместимость слоёв.

---

## 4. Правка схем (контракты и валидация)
**Зачем**: единый язык между FE/BE и внутри BE.  
**Функции**: схемы для чат/стрим, RAG‑ингеста/поиска/анализа, auth/RBAC/тенантов; формат ошибок `{code,message,details}`; генерация типобезопасного клиента для FE.  
**Связь с ТЗ**: снимает “угадайки” и ускоряет разработку.

---

## 5. Правка логики (сервисы/пайплайны)
**Зачем**: вынести бизнес‑логику из хэндлеров, убрать дубли, сделать переиспользуемой.  
**Функции**: тонкие роутеры; сервисы‑фасады: `ChatService` (sync/stream), `RagIngestService` (parse→chunk→embed→index), `RagSearchService` (BM25/Vector), `AnalyzeService` (Q&A/summary), `AuthService` (seed admin, RBAC).  
**Связь с ТЗ**: реализация ключевых сценариев в стабильных точках расширения.

---

## 6. Админка, авторизация, RBAC и онбординг
**Зачем**: официальный способ создать суперпользователя и управлять доступом.  
**Функции**: seed суперпользователя, роли Viewer/Editor/Admin (+Tenant Admin), PAT‑токены/логин, разграничение public/internal/admin ручек.  
**Связь с ТЗ**: e2e‑тесты и мульти‑тенантность без костылей.

---

## 7. Наблюдаемость и эксплуатация
**Зачем**: наблюдаемость и управляемость в проде.  
**Функции**: `/health`, метрики Prometheus, корреляция по `job_id`, согласованный формат логов, алёрты, приоритеты stream/non‑stream.  
**Связь с ТЗ**: SRE‑аспект MVP — быстро понимать состояние и деградации.

---

## 8. Данные и артефакты
**Зачем**: управлять жизненным циклом документов/чанков/векторов/результатов.  
**Функции**: `ArtifactStore` (TTL/ретеншн), версии моделей/датасетов, локальные volumes/S3‑совместимые бэкенды.  
**Связь с ТЗ**: опора RAG/аналитики; без этого растут дубли и хаос.

---

## 9. Фронтенд и клиентские слои
**Зачем**: понятный UI и типобезопасный доступ к API.  
**Функции**: разделы Chat, RAG Chat, Documents, Sources, Settings; SSE‑стримы; общий API‑клиент из схем; устранение дублей компонентов.  
**Связь с ТЗ**: делает сценарии доступными для конечных пользователей MVP.

---

## 10. CI/CD и профили тестов
**Зачем**: быстрые проверки в PR и полный прогон по расписанию.  
**Функции**: профили (быстрый без heavy, полный с heavy/GPU/self‑host), кэш зависимостей/моделей, артефакты/отчёты.  
**Связь с ТЗ**: стабилизирует цикл и снижает стоимость регрессий.

---

## 11. Управление релизами и ветками
**Зачем**: контролируемые изменения без мердж‑ада.  
**Функции**: маленькие PR, конвенции коммитов, версия API и deprecation, CHANGELOG/миграции.  
**Связь с ТЗ**: обратная совместимость и прозрачные релизы.

---

## 12. Безопасность и соответствие
**Зачем**: защитить секреты/операции админов и ограничить риски.  
**Функции**: секреты вне VCS, CI‑secrets, аудит админ‑действий, квоты/лимиты.  
**Связь с ТЗ**: корпоративные требования и мульти‑тенантная безопасность.

---

## 13. Приложения
**Зачем**: быстрый онбординг и единый справочник.  
**Функции**: термины, RACI, чек‑листы ревью/тестов/релиза, карта сервисов/портов (compose), таблица DTO↔storage.  
**Связь с ТЗ**: снижает зависимость от “устной истории”, ускоряет джунов/QA.

---

### Приоритет выполнения блоков
1) **1 + 5 + 2** (ручки, логика, коннекторы) — функциональный скелет.  
2) **4 + 3** (схемы, модели) — типизация и стабильность интерфейсов.  
3) **6 + 7 + 8** (эксплуатация) — наблюдаемость/безопасная работа.  
4) **9 + 10 + 11 + 12** — UX, CI/CD, релизы, безопасность доводим до релизного уровня.
