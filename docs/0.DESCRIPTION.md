# Описание проекта (v0)

## Общее назначение
Это **портал-консультант по базе знаний** компании на базе **LLM + RAG**.  
Пользователь общается с чат-интерфейсом, может подключать свои источники (файлы/URL), система извлекает текст, индексирует в векторном хранилище и использует гибридный поиск, чтобы отвечать с цитатами.  
Есть отдельный сценарий «анализ документа». Проект задуман мульти-тенантным и готовым к он-прем развёртыванию без интернета (локальные HF-модели).

## Основной функционал MVP
- **Классический чат с LLM**: синхронно и стримингом (SSE/WS).
- **Чат с RAG**: гибридный поиск (BM25 + векторный) по загруженным источникам, стриминг ответов.
- **RAG-ингест**: загрузка/обновление/удаление источников, извлечение текста, чанкинг, эмбеддинг несколькими моделями, индексирование, реиндекс.
- **Анализ документа**: загрузка файла → извлечение → Q&A/сводка по документу, экспорт результата.
- **Роли и многотенантность**: Viewer/Editor/Admin; Tenant ID проходит через все операции.
- **UI MVP**: вкладки Chat, RAG Chat, Documents, Sources, Settings; лайв-статусы для стрима и джоб.

## Публичные API
Аутентификация (JWT), разделы **Chats**, **RAG Documents**, **Analyze**; поддержка стрима, пагинации и rate-limit заголовков.  
Примеры ручек:
- `POST /api/auth/login`, `POST /api/auth/register`
- `POST /api/chats`, `GET /api/chats/{id}/messages`, `POST /api/chats/{id}/messages` (**response_stream: true** для SSE)
- `POST /api/rag/upload`, `GET /api/rag/`, `GET /api/rag/{id}`, `POST /api/rag/search`, `PUT /api/rag/{id}/tags`, `POST /api/rag/{id}/archive`, `DELETE /api/rag/{id}`
- `POST /api/analyze/upload`, `GET /api/analyze/`, `GET /api/analyze/{id}/download`
- WebSocket-канал для стриминга чата.

## Архитектура и ключевые решения
- Все сервисы разворачиваются в **Docker** (локально через Compose, в проде — через Docker Swarm).
- Сервисы: **api** (FastAPI), **emb** (Embedding HTTP), **llm** (LLM HTTP), **workers** (Celery), **RabbitMQ**, **Redis** (cache/result), **MinIO/S3**, **Qdrant** (Vector DB), **Nginx** (reverse proxy).
- Реал-тайм путь для чата/чата+RAG идёт **без очередей** (минимальная латентность, стриминг).
- **EMB/LLM — единые HTTP-пулы** с backpressure.
- Векторное хранилище: мультимодельный индекс (несколько коллекций по alias и агрегатор результатов).
- Сетевой слой: Nginx работает как прозрачный reverse proxy (не срезает `/api`).
- Хранилища: артефакты в S3/MinIO (origin + canonical), векторы в Qdrant по **alias-модели**; поиск делает kNN по нескольким коллекциям и сливает результаты (RRF/нормализация).
- Пайплайны: **RAG ingest** (upload→extract→chunk→embed→upsert), **Analyze**, **Chat/RAG Chat** (поиск→LLM).
- Операционные требования: метрики/логи/алерты, приоритеты stream/non-stream, секреты вне VCS.

## Контракты, чеклисты и планы
- **API-контракт** с примерами запросов/ответов, SSE/WS и лимитами.
- **План доводки до ТЗ**: выправить ручки, коннекторы, модели/схемы, сервисы, RBAC/онбординг, наблюдаемость, данные/артефакты, FE, CI/CD, релизы, безопасность.
- **Бэклог по эпикам** (Ручки, Коннекторы, Модели, Схемы, Логика, Админка/RBAC, Наблюдаемость, Данные, Фронтенд, CI/CD).
- **Чеклисты качества** (API, коннекторы, модели, схемы, сервисы, RBAC, наблюдаемость, данные, фронт, CI/CD, тестовая дисциплина).
- **Cursor-правила проекта**: TDD/ATDD, структура репо (`apps/`, `infra/`), единый «реестр компонентов», требования к тестам/покрытию.
- **Реестр компонентов**: что уже есть/в работе (DAL/репозитории/сервисы/контроллеры/таски) и что планируется.


## Дополнения к MVP (из опыта)

Чтобы MVP был жизнеспособным и не встал на типичных проблемах, добавлены минимальные требования:

- Управляемость пайплайнов: статусы, отмена, перезапуск, idempotency.
- Дедупликация контента и нормализация (контент-хэш, стабильно формируемые chunk_id).
- Схема метаданных для RAG (tenant, source_id, chunk_id, page, lang, mime, version, updated_at, tags[]).
- Гибридный поиск (векторный + лексический fallback), агрегация результатов (RRF/нормализация).
- Кэширование ответов и инвалидация при обновлении источников.
- Минимальная безопасность: ротация JWT-ключей, строгие границы tenant в DAL, аудит админ-действий.
- Наблюдаемость: healthz/readyz, p95 latency, 5xx, глубина очередей, корреляция request_id.
- Nginx-настройки для SSE/WS (proxy_buffering off, таймауты, лимиты upload).
- Лимиты и backpressure для LLM/EMB, dead-letter очереди для Celery.
- UX-мелочи: плашка maintenance, предсказуемые ответы на пустую выдачу, версия билда в UI.

Пункты CI/CD smoke-тестов и автоматических бэкапов отмечены как **заглушки** — закладываются места в коде и структуре, но реализуются после основных фич.

## TO‑BE Backend Structure

## TO‑BE Backend Structure (суммарно)
- `app/core`: конфигурация, middleware, ошибки, логирование
- `app/api/v1`: роутеры FastAPI по доменам (auth, users, chat, rag, analyze, admin), корневой `router` с `/api/v1`
- `app/schemas`: Pydantic‑схемы (Problem, Pagination, Chat/RAG/Analyze/Jobs и пр.)
- `app/services`: бизнес‑логика доменов
- `app/repositories`: доступ к данным и хранилищам
- `app/adapters`: клиенты LLM/Embeddings/Qdrant/MinIO
- `app/workers`: фоновые задачи (ingest/reindex)
- `main.py`: инициализация приложения и монтирование `api/v1`
