# 1.DEVOPS.md

> Объединённый документ. Содержит как инфраструктурную картину (MVP), так и требования заказчика к DevOps. Является полной основой для последующей детализации.

# Инфраструктура (index 1)

> Базируется на **Описание проекта (index 0)**. Этот документ фиксирует целевую инфраструктуру для MVP и задаёт рельсы для безболезненного роста.

## 1. Архитектурные принципы
- **Docker-first**: локально — `docker-compose`, прод — **Docker Swarm** (`docker stack deploy`), с последующей переносимостью в Kubernetes.
- **Прозрачный reverse-proxy**: Nginx (или Traefik как альтернатива) без срезания `/api`.
- **Разделение путей**: real-time (чат/стрим) — напрямую к API/LLM/EMB; batch (ingest/analyze/maintenance) — через Celery/RabbitMQ.
- **Оффлайн-режим**: модели и артефакты хранятся локально (MinIO/volume). Никаких внешних исходов в проде.
- **12-Factor**: конфигурация исключительно через env/secrets, неизменяемые контейнеры, idempotent деплой.

## 2. Сервисы
- **api** (FastAPI): REST/SSE/WS; авторизация JWT; presigned-URL для S3/MinIO; оркестрация фоновых задач.
- **emb**: HTTP-сервис эмбеддингов (мультимодельный), поддержка батчей и backpressure.
- **llm**: HTTP-сервис генерации (chat/complete) со стримингом, контролем токен-бюджета и backpressure.
- **workers**: Celery для ingest/analyze/maintenance.
- **rabbitmq**: брокер для Celery.
- **redis**: кеш, локи, rate limiting, idempotency keys, Celery result backend (опционально), НЕ источник истины.
- **postgres**: основная БД (пользователи, чаты, документы/мета, статусы пайплайнов).
- **qdrant**: векторное хранилище (multi-index на alias-моделях, агрегатор результатов).
- **minio**: S3-совместимое хранилище файлов/артефактов, версии и жизненный цикл объектов.
- **nginx**: TLS termination, роутинг, лимиты, защиты.
- **frontend** (Next.js): UI (Chat, RAG Chat, Documents, Sources, Settings).

### Роли данных
- **System of Record**: PostgreSQL.
- **Кеш/эпhemeral**: Redis.
- **Поиск/ML**: Qdrant (векторы), MinIO (сырьё и артефакты), локальные volume (модели).
- **Очереди**: RabbitMQ.

## 3. База данных: best practices
- PostgreSQL остаётся **единственным источником истины** (чаты, пользователи, документы, статусы). Причины:
  - транзакционность, миграции, целостность (FK, уникальные индексы);
  - удобная аналитика/репликация/backup;
  - предсказуемая эксплуатация.
- Redis используется для: кэша (TTL), rate limiting, distributed locks, idempotency, сессионные ключи (если нужно), короткие очереди/сигналы.
- Миграции — **Alembic** (или yoyo/tern), strict policy: миграции обязательны для CI.
- Резервное копирование: `pg_dump` + point-in-time recovery (WAL) в MinIO; реплика read-only — опционально.
- События к интеграциям — **Outbox pattern** (таблица outbox + воркер доставки) при необходимости.

## 4. Сеть и безопасность
- Nginx: TLS 1.2+, HSTS, лимиты тела (`client_max_body_size` по потребности), ограничение на количество соединений/запросов.
- Внутри overlay-сети Swarm: сервисы по DNS-имени (`api`, `emb`, `llm`, `redis`, `qdrant`, `postgres`, `minio`, `rabbitmq`).
- Секреты: Swarm secrets/Config, никаких секретов в VCS. Rotate policy.
- JWT, роли Viewer/Editor/Admin (+Tenant Admin). Подпись токенов через JWK/rotating keys.
- Presigned-URL к MinIO, доступ по IAM-пользователям с policy на конкретные префиксы `tenant/*`.

## 5. Пайплайны
1) **RAG Ingest**: upload → extract → chunk → embed (N моделей) → upsert в Qdrant → индексы обновлены → статус `ready` в Postgres.  
2) **Analyze**: upload → extract → embed/aggregate → LLM complete → артефакт → статус `ready`.  
3) **Chat/Chat+RAG**: запрос → (embed + kNN по коллекциям) → агрегатор (RRF/score norm) → LLM (stream).

## 6. Наблюдаемость (сегодня и рост)
- **Сейчас (MVP)**: Prometheus метрики (API/LLM/EMB/Workers), alerter по p95 latency, ошибкам 5xx, длине очередей, stuck tasks.
- **Логи**: JSON-логгинг с `request_id`, `tenant_id`, `doc_id`. Хранение локально + форвардинг в stdout.
- **Дальше без боли**:
  - OpenTelemetry экспорт (OTLP) включаем флагом;
  - централизованный логинг (Loki/ELK/OpenSearch) — подключается через дополнительный sidecar/агент;
  - трейсинг запросов (API↔LLM↔EMB↔Workers)—отключаемый.

## 7. Модели оффлайн
- Каталог моделей: volume или MinIO bucket `models/` с версионированием и checksum (SHA256).
- **manifest.json**: имя, версия, тип (embed/llm), размер, hash, local path, alias для индексов Qdrant.
- Обновление моделей — через maintenance-задачи: прогрев кэша, откат на предыдущую версию по feature-flag.
- Никаких запросов наружу в проде. Загрузка/обновление — вручную/скриптом перед релизом.

## 8. Деплой и скейлинг
- **Swarm (MVP)**: `deploy.replicas`, `resources.limits/reservations`, healthchecks, restart policy, отдельные сети для фронта/бэка/хранилищ.
- Горизонтальное масштабирование real-time: `llm`, `emb`, `api` (sticky или stateless); batch — `workers`.
- Версионирование стэков: `stack vA.B` с откатами (`rollback`) и совместимостью контрактов API.

## 9. Environments (куда вынести dev/test)
Рекомендуется отдельный документ **ENVIRONMENTS (index 2)** со схемами:
- `local-dev`: compose, hot-reload, тестовые модели.
- `ci-preview`: ephemeral stack на таргет-ветку (миграции, smoke).
- `staging`: продоподобное, закрытое наружу.
- `prod`: Swarm, ограниченный доступ, только оффлайн модели.
В этот документ поместим матрицу переменных окружения, профили сборки образов, политику миграций и прогрева индексов.




# 2.REQUIREMENTS_DEVOPS.md

> Зафиксированные требования от заказчика (MVP). Документ описывает **как должно выглядеть** с точки зрения DevOps **без** низкоуровневых реализаций и переменных.

## 1. Базовые принципы
- Всё в **Docker**: локально — `docker-compose`, прод (MVP) — **Docker Swarm** (`docker stack deploy`).
- **Прозрачный Nginx** как reverse proxy (не срезает `/api`); TLS можно прикрутить позже.
- **Оффлайн-прод**: внешние исходящие отключены; модели загружаются вручную на хост и монтируются (volume/MinIO).
- Разделение путей: real-time (чат/стрим) — напрямую к API/LLM/EMB; batch (ingest/analyze/maintenance) — через Celery/RabbitMQ.
- 12-factor — рамочно: секреты не в VCS; конфиги через окружение (детализация позже).

## 2. Окружения и доступ
- Окружения: **local**, **staging**, **prod** (детализация dev/test позже, отдельным документом).
- Доступ закрытый, внутренняя маленькая команда; дополнительных механизмов контроля доступа **пока не требуется**.
- Перспектива переноса на **Kubernetes** — возможна позже, не цель MVP.

## 3. Инфраструктурные компоненты (MVP)
- **API** (FastAPI), **LLM** (HTTP), **EMB** (HTTP), **Workers** (Celery).
- **RabbitMQ** (очереди), **Redis** (кэш/локи/idempotency).
- **PostgreSQL** — **единственный источник истины** (пользователи, чаты, документы/мета, статусы).
- **Qdrant** — векторы; **MinIO/S3** — файлы/артефакты/модели.
- **Frontend** (Next.js), **Nginx** (reverse proxy).

## 4. Данные и роли хранилищ
- PostgreSQL — транзакционная база, все бизнес-данные и статусы пайплайнов.
- Redis — только эпемерные данные: кэши, локи, rate limiting, идемпотентность.
- Qdrant — векторные индексы; MinIO — артефакты/модели/сырьё.

## 5. Наблюдаемость (минимум на MVP)
- Метрики и алерты по ключевым точкам: p95 latency, ошибки 5xx, длина очередей Celery, stuck tasks.
- Структурированные логи (JSON или аналог) с корреляцией `request_id`/`tenant_id`.
- Возможность **безболезненно** подключить централизованный логинг/трейсинг позже (без обязательств на MVP).

## 6. Безопасность (рамочно)
- JWT + роли Viewer/Editor/Admin (+Tenant Admin).
- Presigned-URL к MinIO; сегрегация по tenant-префиксам.
- Секреты — вне VCS; механизм доставки/ротации уточним при реализации.

## 7. Деплой, рост и соответствие
- Целевая платформа деплоя на MVP — **Docker Swarm**.
- Масштабирование горизонтальное по `api/llm/emb/workers` при необходимости.
- Переносимость к Kubernetes планируется, но **не** в рамках MVP.

## 8. SLO/SLA и отказоустойчивость
- SLO/SLA: **best effort** на MVP (без формальных процентов).
- RPO/RTO: **не задаются** на MVP (без гарантий). Бэкапы и DR-процедуры обсудим позже.

## 9. Доступ, сеть, TLS
- Доступ к staging/prod — ограниченный, внутренняя команда, без сложных схем (VPN/bastion не обязателен на MVP).
- TLS-сертификатов сейчас **нет**; при необходимости будет добавлен на Nginx позже.

## 10. Аппаратные ресурсы (MVP)
- **GPU — нет** на MVP (появятся после MVP).
- Сервер(а): ~ **12 CPU ядер и 80 ГБ RAM** (×2 машины под вычисления/сервисы).
- Отдельная машина под хранилища — **в 2 раза меньше ресурсов**, с дисками под MinIO/PostgreSQL/Qdrant.
- Конкретные профили ресурсов/лимиты — определим в реализации.

## 11. Логи и ретеншн
- Логи — писать в файл на хосте/в контейнере с **ротацией раз в несколько дней**.
- Политики хранения для артефактов/моделей/бэкапов — определим позже.

## 12. Не цели MVP / отложенные решения
- Централизованный логинг (ELK/Loki/OpenSearch) — отложено.
- Полный трейсинг (OTEL) — отложено, должна быть возможность включить позже.
- Формальные SLA, DRP, RPO/RTO — отложены.
- Kubernetes — отложено.
- Политики ретеншна (артефакты/модели/логи) — отложены.

## 13. Связанные документы
- **0.DESCRIPTION.md** — общее описание продукта.
- **1.INFRASTRUCTURE.md** — инфраструктурная картина (MVP).
- (черновик) **ENVIRONMENTS** — будет оформлен позже, когда придём к переменным/процессам.


## Дополнения (из опыта, MVP)

### Пайплайны
- Все задачи ingest/analyze поддерживают статусы `queued → running → ready/failed/canceled`.
- Возможность отмены и перезапуска задач (cancel/retry).
- Idempotency: повторный запуск не создаёт дубликатов (ключ = source_id + content_hash + step).
- Dead-letter очередь в Celery для ядовитых задач.

### Контент и индексы
- Контент-хэш и дедупликация на уровне артефакта и чанка.
- Нормализация текстов (кодировки, переносы, HTML/мусор).
- OCR оффлайн (флаг) для сканов.
- Метаданные в Qdrant payload: tenant, source_id, chunk_id, page, lang, mime, version, updated_at, tags[].
- Версионирование эмбеддингов: embed_model_alias, embed_model_version.

### Поиск
- Гибридный: векторный + лексический fallback (Postgres FTS или Qdrant payload index).
- Агрегация результатов (RRF/нормализация), MMR/diversity флаг.

### Кэширование
- Ключ = нормализованный вопрос + хэш top-N документов.
- Инвалидация по source_id при обновлении/реиндексе.

### Безопасность
- JWT-ключи с ротацией (активный + следующий).
- Жёсткие проверки tenant scope на уровне DAL.
- Аудит лог админских действий (отмена джоб, переиндекс).

### Наблюдаемость
- healthz и readyz у всех сервисов.
- p95 latency, ошибки 5xx, длина очередей, активные SSE.
- Корреляция request_id во всех логах, включая SSE/WS.

### Nginx
- proxy_buffering off для SSE.
- proxy_read_timeout ≥ 3600s, корректные заголовки Upgrade/Connection для WS.
- Ограничение одновременных SSE/WS потоков на токен.
- client_max_body_size и лимиты upload.

### Лимиты и backpressure
- Параллелизм для LLM/EMB ограничен, очередь ожидания с отказом при переполнении.
- Celery: acks_late, ограниченный prefetch, retry policy + dead-letter.

### UX
- Плашка maintenance/readonly.
- Предсказуемые ответы при пустой выдаче и превышении лимитов.
- Версия билда в UI (/api/version).

### CI/CD и бэкапы
- Заглушки для smoke-suite после деплоя (healthz, чат SSE, ingest mini-файла, kNN, гибридный поиск).
- Заглушки для nightly pg_dump + Qdrant snapshot + MinIO.
