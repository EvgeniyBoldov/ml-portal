# Backend Structure Guide - FINAL

apps/api/
├── src/app/                    # Основной код приложения
│   ├── main.py                 # Точка входа FastAPI
│   ├── celery_app.py           # Конфигурация Celery
│   │
│   ├── api/                    # API слой
│   │   ├── v1/                 # Версионированные эндпоинты
│   │   │   ├── router.py       # Главный роутер v1
│   │   │   ├── routers/        # Доменные роутеры
│   │   │   │   ├── auth.py     # Аутентификация
│   │   │   │   ├── users.py    # Управление пользователями
│   │   │   │   ├── chats.py    # Чат функциональность
│   │   │   │   ├── rag.py      # RAG операции
│   │   │   │   ├── analyze.py  # Анализ документов
│   │   │   │   └── admin.py    # Админ функции
│   │   │   ├── health.py       # Health check
│   │   │   ├── tenants.py      # Управление тенантами
│   │   │   ├── models.py       # Управление моделями
│   │   │   ├── artifacts.py    # Артефакты
│   │   │   ├── jobs.py         # Фоновые задачи
│   │   │   └── password_reset.py # Сброс паролей
│   │   ├── controllers/        # Контроллеры
│   │   │   └── _base.py        # Базовый контроллер
│   │   ├── dev/                # DEV-only эндпоинты
│   │   │   └── setup.py        # Setup для разработки (DEBUG=true)
│   │   ├── deps.py             # Зависимости FastAPI
│   │   └── deps_idempotency.py # Идемпотентность
│   │
│   ├── core/                   # Ядро приложения
│   │   ├── config.py           # Конфигурация
│   │   ├── db.py               # База данных
│   │   ├── security.py         # Безопасность
│   │   ├── logging.py          # Логирование
│   │   ├── middleware.py       # Основной middleware
│   │   ├── middleware/          # Middleware модули
│   │   │   ├── idempotency.py  # Идемпотентность (строгая версия)
│   │   │   └── rate_limit.py   # Rate limiting
│   │   ├── exceptions.py       # Исключения
│   │   ├── redis.py            # Redis
│   │   ├── metrics.py          # Prometheus метрики
│   │   ├── idempotency.py      # Идемпотентность (ядро)
│   │   ├── tenant_validation.py # Валидация тенантов
│   │   ├── audit.py            # Аудит
│   │   ├── di.py               # Dependency Injection
│   │   ├── uow.py              # Unit of Work
│   │   ├── constants.py        # Константы
│   │   ├── errors.py           # Ошибки
│   │   ├── exception_handlers.py # Обработчики ошибок
│   │   ├── domain_exceptions.py # Доменные исключения
│   │   ├── job_storage.py      # Хранилище задач
│   │   ├── message_content.py  # Контент сообщений
│   │   ├── model_registry.py   # Реестр моделей
│   │   ├── pat_validation.py   # Валидация PAT токенов
│   │   ├── rag_integrity.py    # Целостность RAG
│   │   ├── s3_links.py         # S3 ссылки
│   │   ├── sse_protocol.py     # Server-Sent Events
│   │   └── debug_routes.py     # Debug роуты
│   │
│   ├── models/                 # SQLAlchemy модели
│   │   ├── base.py             # Базовая модель
│   │   ├── user.py             # Пользователи
│   │   ├── chat.py             # Чаты
│   │   ├── rag.py              # RAG документы
│   │   └── analyze.py          # Анализ
│   │
│   ├── repositories/            # Репозитории (DAL)
│   │   ├── base.py             # Базовый репозиторий
│   │   ├── factory.py          # Фабрика репозиториев
│   │   ├── users_repo.py       # Пользователи
│   │   ├── chats_repo.py       # Чаты
│   │   ├── rag_repo.py         # RAG документы
│   │   ├── documents_repo.py   # Документы (было rag_documents_repo)
│   │   ├── analyze_repo.py     # Анализ
│   │   ├── tenants_repo.py     # Тенанты
│   │   ├── idempotency_repo.py # Идемпотентность
│   │   └── jobs_repo.py        # Задачи
│   │
│   ├── services/                # Бизнес-логика
│   │   ├── _base.py            # Базовый сервис
│   │   ├── users_service.py    # Пользователи
│   │   ├── chats_service.py    # Чаты
│   │   ├── rag_service.py      # RAG операции
│   │   ├── analyze_service.py  # Анализ
│   │   ├── jobs_service.py     # Задачи (было api/v1/jobs.py)
│   │   ├── auth_service.py     # Аутентификация
│   │   ├── audit_service.py    # Аудит
│   │   ├── tenants_service.py  # Тенанты
│   │   ├── idempotency_service.py # Идемпотентность
│   │   ├── service_with_idempotency.py # Миксин идемпотентности
│   │   ├── clients.py          # HTTP клиенты
│   │   ├── model_catalog.py    # Каталог моделей
│   │   ├── rag_ingest_service.py # Ингestion RAG
│   │   ├── rag_search_service.py # Поиск RAG
│   │   ├── chat_service.py     # Чат сервис
│   │   ├── text_extractor.py   # Извлечение текста
│   │   └── text_normalizer.py  # Нормализация текста
│   │
│   ├── schemas/                 # Pydantic схемы
│   │   ├── users.py            # Пользователи
│   │   ├── chats.py            # Чаты
│   │   ├── chat_messages.py    # Сообщения чата
│   │   ├── rag.py              # RAG
│   │   ├── analyze.py          # Анализ
│   │   ├── auth.py             # Аутентификация
│   │   ├── common.py           # Общие схемы (ProblemDetails, Pagination)
│   │   └── repository_schemas.py # Схемы репозиториев
│   │
│   ├── adapters/                # Адаптеры внешних сервисов
│   │   ├── llm_client.py       # LLM клиент
│   │   ├── emb_client.py       # Embeddings клиент
│   │   ├── qdrant_client.py    # Qdrant клиент (было core/qdrant.py)
│   │   ├── s3_client.py        # S3 клиент (было core/s3.py)
│   │   ├── email_client.py     # Email клиент
│   │   └── queue_client.py     # Queue клиент
│   │
│   ├── workers/                 # Celery задачи
│   │   ├── tasks_maintenance.py # Периодические задачи (было periodic_tasks.py)
│   │   ├── tasks_ingest.py     # Ингestion задачи (было task_manager.py)
│   │   ├── tasks_analyze.py    # Анализ задачи
│   │   └── __init__.py         # Общие утилиты (было shared.py)
│   │
│   ├── storage/                 # Хранилище
│   │   └── paths.py            # Пути к файлам
│   │
│   ├── migrations/              # Миграции БД
│   │   ├── env.py              # Конфигурация Alembic
│   │   └── versions/           # Версии миграций
│   │
│   ├── llm/                     # LLM промпты
│   │   └── prompts/            # Промпты
│   │
│   ├── scripts/                 # Скрипты
│   │   └── create_superuser.py  # Создание суперпользователя
│   │
│   └── tests/                   # Тесты (было в корне)
│       ├── api/                 # API тесты
│       ├── integration/         # Интеграционные тесты
│       ├── unit/                # Юнит тесты
│       ├── contract/            # Контрактные тесты
│       └── conftest.py          # Конфигурация pytest
│
├── alembic.ini                  # Конфигурация миграций
├── pyproject.toml               # Конфигурация проекта
├── pytest.ini                   # Конфигурация тестов
├── requirements.txt             # Зависимости
├── requirements-test.txt        # Тестовые зависимости
└── Makefile                     # Команды сборки
