# –û—Ç—á–µ—Ç –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## üîç **–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**

### **1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `credentials: 'include'` –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `refresh()`**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞ –∫—É–∫–∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ë—ç–∫–µ–Ω–¥ –Ω–µ –º–æ–≥ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å refresh_token –∏–∑ –∫—É–∫–∏

### **2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ `apiFetch`**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç –≤ localStorage, –∑–∞–ø—Ä–æ—Å –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª—Å—è
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –§—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ –º–æ–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—É–∫–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### **3. –£—Å–ª–æ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ 401 –æ—à–∏–±–∫–∏**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –±—ã–ª –≤ localStorage
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫, —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ –º–æ–≥ –µ–≥–æ –æ–±–Ω–æ–≤–∏—Ç—å

## üîß **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

### **1. –î–æ–±–∞–≤–ª–µ–Ω `credentials: 'include'` –≤ —Ñ—É–Ω–∫—Ü–∏—é `refresh()`:**
```typescript
async function refresh() {
  const res = await fetch(API_BASE + '/auth/refresh', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ refresh_token: refreshToken() }),
    credentials: 'include', // Include cookies in refresh request
  });
  // ...
}
```

### **2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:**
```typescript
// Only add Authorization header if auth is not disabled and we have a token
if (opts.auth !== false) {
  const authToken = token();
  if (authToken) {
    headers['Authorization'] = 'Bearer ' + authToken;
  }
  // If no token in localStorage, we still send the request with cookies
  // The backend will check cookies if no Authorization header is provided
}
```

### **3. –£–±—Ä–∞–Ω–∞ —É—Å–ª–æ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è 401 –æ—à–∏–±–∫–∏:**
```typescript
let res = await doFetch();
if (res.status === 401) { // –£–±—Ä–∞–ª–∏ && token()
  try {
    const t = await refresh();
    headers['Authorization'] = 'Bearer ' + t;
    res = await doFetch();
  } catch {
    del('token');
    del('refresh_token');
    throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
  }
}
```

## üìã **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**

### **–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:**
1. **–ö—É–∫–∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å –ø—Ä–∏ refresh** - –±—ç–∫–µ–Ω–¥ –Ω–µ –º–æ–≥ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å refresh_token
2. **–ó–∞–ø—Ä–æ—Å—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å –±–µ–∑ —Ç–æ–∫–µ–Ω–∞** - —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª–∞–≥–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ localStorage
3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ** - –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫, —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ –º–æ–≥ –µ–≥–æ –æ–±–Ω–æ–≤–∏—Ç—å

### **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
1. **–ö—É–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤—Å–µ–≥–¥–∞** - `credentials: 'include'` –≤–æ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
2. **–ó–∞–ø—Ä–æ—Å—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –¥–∞–∂–µ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞** - –±—ç–∫–µ–Ω–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫—É–∫–∏
3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞** - –ø—Ä–∏ –ª—é–±–æ–π 401 –æ—à–∏–±–∫–µ

## üéØ **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∫—É–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç** - —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—É–∫–∏
- ‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç** - refresh_token –∏–∑ –∫—É–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- ‚úÖ **–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–∞–±–æ—Ç–∞–µ—Ç** - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
- ‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - localStorage —Ç–æ–∫–µ–Ω—ã –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞—é—Ç

## üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
1. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞** - –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å
2. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∫—É–∫–∏** - –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å
3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞** - –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å
4. **–°–º–µ—à–∞–Ω–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - localStorage + –∫—É–∫–∏ –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å

–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ —Å –∫—É–∫–∏ –≤ `apiFetch`! üéâ
