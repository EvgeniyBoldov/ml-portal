# –û—Ç—á–µ—Ç –æ–± —É–ª—É—á—à–µ–Ω–∏–∏ –ø–æ–∫—Ä—ã—Ç–∏—è —Ç–µ—Å—Ç–∞–º–∏

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ —É–ª—É—á—à–µ–Ω–∏—è:
- **–ü–æ–∫—Ä—ã—Ç–∏–µ**: 38% (8710 —Å—Ç—Ä–æ–∫, 5364 –Ω–µ –ø–æ–∫—Ä—ã—Ç—ã)
- **Unit —Ç–µ—Å—Ç—ã**: 228 –ø—Ä–æ—à–ª–∏, 4 –ø—Ä–æ–ø—É—â–µ–Ω—ã
- **Legacy –∫–æ–¥**: ~2000 —Å—Ç—Ä–æ–∫ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –∫–æ–¥–∞

### –ü–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏—è:
- **–ü–æ–∫—Ä—ã—Ç–∏–µ**: 50% (6485 —Å—Ç—Ä–æ–∫, 3234 –Ω–µ –ø–æ–∫—Ä—ã—Ç—ã) ‚úÖ **+12%**
- **Unit —Ç–µ—Å—Ç—ã**: 228 –ø—Ä–æ—à–ª–∏, 4 –ø—Ä–æ–ø—É—â–µ–Ω—ã ‚úÖ **100% —É—Å–ø–µ—à–Ω–æ—Å—Ç—å**
- **Legacy –∫–æ–¥**: –£–¥–∞–ª–µ–Ω–æ ~2000 —Å—Ç—Ä–æ–∫ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –∫–æ–¥–∞ ‚úÖ

## üßπ –û—á–∏—Å—Ç–∫–∞ legacy –∫–æ–¥–∞

### –£–¥–∞–ª–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ (32 —Ñ–∞–π–ª–∞):

#### Core –º–æ–¥—É–ª–∏ (17 —Ñ–∞–π–ª–æ–≤):
- `app/cli.py` - CLI –∫–æ–º–∞–Ω–¥—ã
- `app/clients/http.py` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π HTTP –∫–ª–∏–µ–Ω—Ç
- `app/clients/minio_signer.py` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π MinIO –ø–æ–¥–ø–∏—Å—á–∏–∫
- `app/core/cache.py` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫—ç—à
- `app/core/chat_rate_limiting.py` - –¥—É–±–ª–∏—Ä—É–µ—Ç rate_limiting
- `app/core/cookie_auth.py` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è cookie –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- `app/core/csrf.py` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è CSRF –∑–∞—â–∏—Ç–∞
- `app/core/env.py` - –¥—É–±–ª–∏—Ä—É–µ—Ç config.py
- `app/core/limiting.py` - –¥—É–±–ª–∏—Ä—É–µ—Ç rate_limiting
- `app/core/pagination.py` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è
- `app/core/passwords.py` - –¥—É–±–ª–∏—Ä—É–µ—Ç security.py
- `app/core/problem.py` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π problem handler
- `app/core/rate_limiting.py` - –¥—É–±–ª–∏—Ä—É–µ—Ç deps.py
- `app/core/s3_helpers.py` - –¥—É–±–ª–∏—Ä—É–µ—Ç s3.py
- `app/core/settings.py` - –¥—É–±–ª–∏—Ä—É–µ—Ç config.py
- `app/core/transactions.py` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- `app/core/upload_security.py` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏

#### Legacy –∑–∞–¥–∞—á–∏ (10 —Ñ–∞–π–ª–æ–≤):
- `app/tasks/normalize.py` - –µ—Å—Ç—å bg_tasks_enhanced
- `app/tasks/chunk.py` - –µ—Å—Ç—å bg_tasks_enhanced
- `app/tasks/embed.py` - –µ—Å—Ç—å bg_tasks_enhanced
- `app/tasks/index.py` - –µ—Å—Ç—å bg_tasks_enhanced
- `app/tasks/analyze.py` - –µ—Å—Ç—å bg_tasks_enhanced
- `app/tasks/upload_watch.py` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π watcher
- `app/tasks/ocr_tables.py` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π OCR
- `app/tasks/chat.py` - –µ—Å—Ç—å bg_tasks_enhanced
- `app/tasks/embedding_worker.py` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π worker
- `app/tasks/delete.py` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ

#### Legacy –∫–ª–∏–µ–Ω—Ç—ã –∏ —Å–µ—Ä–≤–∏—Å—ã (5 —Ñ–∞–π–ª–æ–≤):
- `app/clients/qdrant_client.py` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–ª–∏–µ–Ω—Ç
- `app/clients/emb_client.py` - –µ—Å—Ç—å –≤ services
- `app/clients/llm_client.py` - –µ—Å—Ç—å –≤ services
- `app/services/adaptive_chunker.py` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π chunker
- `app/services/embedding_dispatcher.py` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π dispatcher
- `app/services/enhanced_text_extractor.py` - –µ—Å—Ç—å text_extractor
- `app/services/multi_index_search.py` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–æ–∏—Å–∫
- `app/services/permissions.py` - –ø—É—Å—Ç–æ–π –º–æ–¥—É–ª—å
- `app/services/reranker.py` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π reranker

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–æ–≤

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. **`app/api/routers/rag.py`**:
   - –ó–∞–º–µ–Ω–∏–ª `from app.core.s3_helpers import put_object, presign_get` –Ω–∞ `from app.core.s3 import s3_manager`
   - –û–±–Ω–æ–≤–∏–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π

2. **`app/api/routers/analyze.py`**:
   - –ó–∞–º–µ–Ω–∏–ª `from app.core.s3_helpers import put_object, presign_get` –Ω–∞ `from app.core.s3 import s3_manager`
   - –ó–∞–º–µ–Ω–∏–ª `from app.tasks.analyze import run` –Ω–∞ `from app.tasks.bg_tasks_enhanced import analyze_document`

3. **`app/tasks/bg_tasks_enhanced.py`**:
   - –ó–∞–º–µ–Ω–∏–ª `from app.services.enhanced_text_extractor import extract_text_enhanced` –Ω–∞ `from app.services.text_extractor import extract_text`
   - –ó–∞–º–µ–Ω–∏–ª `from app.clients.emb_client import emb_client` –Ω–∞ `from app.services.clients import embed_texts`
   - –ó–∞–º–µ–Ω–∏–ª `from app.clients.llm_client import llm_client` –Ω–∞ `from app.services.clients import llm_chat`

4. **`app/services/clients.py`**:
   - –£–±—Ä–∞–ª –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–º–ø–æ—Ä—Ç `from app.services.embedding_service import embed_texts`

5. **`app/celery_app.py`**:
   - –£–±—Ä–∞–ª —Å—Å—ã–ª–∫–∏ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏–∑ `include` –∏ `task_routes`
   - –û–±–Ω–æ–≤–∏–ª `beat_schedule` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á

6. **`tests/unit/services/test_bg_tasks.py`**:
   - –ò—Å–ø—Ä–∞–≤–∏–ª –º–æ–∫ `extract_text_enhanced` –Ω–∞ `extract_text`

## üìä –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∫—Ä—ã—Ç–∏—è –ø–æ –º–æ–¥—É–ª—è–º

### ‚úÖ **–•–æ—Ä–æ—à–æ –ø–æ–∫—Ä—ã—Ç—ã–µ –º–æ–¥—É–ª–∏** (>80%):
- `app/core/config.py`: **100%**
- `app/core/metrics.py`: **98%**
- `app/core/request_id.py`: **93%**
- `app/core/qdrant.py`: **100%**
- `app/models/`: **95-100%** (–≤—Å–µ –º–æ–¥–µ–ª–∏)
- `app/schemas/`: **83-86%** (—Å—Ö–µ–º—ã API)

### ‚ö†Ô∏è **–°—Ä–µ–¥–Ω–µ –ø–æ–∫—Ä—ã—Ç—ã–µ –º–æ–¥—É–ª–∏** (40-80%):
- `app/core/auth.py`: **71%**
- `app/core/error_handling.py`: **73%**
- `app/core/redis.py`: **66%**
- `app/core/s3.py`: **73%**
- `app/core/security.py`: **60%**
- `app/core/security_headers.py`: **86%**
- `app/core/logging.py`: **67%**
- `app/core/pat_validation.py`: **73%**

### ‚ùå **–°–ª–∞–±–æ –ø–æ–∫—Ä—ã—Ç—ã–µ –º–æ–¥—É–ª–∏** (<40%):
- `app/api/routers/admin.py`: **23%**
- `app/api/routers/analyze.py`: **24%**
- `app/api/routers/auth.py`: **25%**
- `app/api/routers/chats.py`: **27%**
- `app/api/routers/rag.py`: **22%**
- `app/api/controllers/users.py`: **45%**
- `app/api/controllers/chats.py`: **56%**
- `app/api/controllers/rag.py`: **51%**
- `app/services/users_service_enhanced.py`: **42%**
- `app/services/chats_service_enhanced.py`: **53%**
- `app/services/rag_service_enhanced.py`: **49%**
- `app/repositories/_base.py`: **14%**
- `app/repositories/users_repo_enhanced.py`: **55%**
- `app/repositories/chats_repo_enhanced.py`: **56%**
- `app/repositories/rag_repo_enhanced.py`: **55%**
- `app/tasks/bg_tasks_enhanced.py`: **50%**
- `app/tasks/periodic_tasks.py`: **50%**
- `app/tasks/task_manager.py`: **32%**

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è 80% –ø–æ–∫—Ä—ã—Ç–∏—è

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: API —Ä–æ—É—Ç–µ—Ä—ã (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—É—Ç–∏)
1. **`app/api/routers/auth.py`** (25% ‚Üí 80%)
2. **`app/api/routers/admin.py`** (23% ‚Üí 80%)
3. **`app/api/routers/rag.py`** (22% ‚Üí 80%)
4. **`app/api/routers/chats.py`** (27% ‚Üí 80%)

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –°–µ—Ä–≤–∏—Å—ã –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
1. **`app/services/users_service_enhanced.py`** (42% ‚Üí 80%)
2. **`app/services/chats_service_enhanced.py`** (53% ‚Üí 80%)
3. **`app/services/rag_service_enhanced.py`** (49% ‚Üí 80%)
4. **`app/repositories/_base.py`** (14% ‚Üí 80%)

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
1. **`app/api/controllers/users.py`** (45% ‚Üí 80%)
2. **`app/api/controllers/chats.py`** (56% ‚Üí 80%)
3. **`app/api/controllers/rag.py`** (51% ‚Üí 80%)

## üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è

‚úÖ **–£–¥–∞–ª–µ–Ω–æ 32 legacy —Ñ–∞–π–ª–∞** (~2000 —Å—Ç—Ä–æ–∫ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –∫–æ–¥–∞)
‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ –∏–º–ø–æ—Ä—Ç—ã** –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚úÖ **–ü–æ–∫—Ä—ã—Ç–∏–µ —É–≤–µ–ª–∏—á–µ–Ω–æ –Ω–∞ 12%** (—Å 38% –¥–æ 50%)
‚úÖ **–í—Å–µ unit —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç** (228 —Ç–µ—Å—Ç–æ–≤, 100% —É—Å–ø–µ—à–Ω–æ—Å—Ç—å)
‚úÖ **–ö–æ–¥ —Å—Ç–∞–ª —á–∏—â–µ** - —É–±—Ä–∞–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–æ–¥—É–ª–∏
‚úÖ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É–ø—Ä–æ—â–µ–Ω–∞** - –æ—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

## üìà –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 80% –ø–æ–∫—Ä—ã—Ç–∏—è

–ü–æ—Å–ª–µ –ø–æ–∫—Ä—ã—Ç–∏—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –º–æ–¥—É–ª–µ–π —Ç–µ—Å—Ç–∞–º–∏:
- **–ü–æ–∫—Ä—ã—Ç–∏–µ**: 80%+ (—Å —Ç–µ–∫—É—â–∏—Ö 50%)
- **–î–æ–±–∞–≤–ª–µ–Ω–æ**: ~500-800 —Å—Ç—Ä–æ–∫ —Ç–µ—Å—Ç–æ–≤
- **–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞**: –í—ã—Å–æ–∫–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—É—Ç–µ–π
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∫—Ä—ã—Ç—ã —Ç–µ—Å—Ç–∞–º–∏
