# –û—Ç—á–µ—Ç –ø–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—é —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –∑–∞–¥–∞–Ω–∏—é

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è

### 1. **–ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö / –º–∏–≥—Ä–∞—Ü–∏–∏** ‚úÖ
- **CHECK constraint –¥–ª—è role**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ –º–∏–≥—Ä–∞—Ü–∏–∏ `20250115_000000_rbac_admin_models.py`
- **–í—Å–µ –ø–æ–ª—è —Ç–∞–±–ª–∏—Ü —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –¢–ó**: ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ `app/models/user.py`
  - `users`: id, login, password_hash, role VARCHAR(20) + CHECK, email, is_active, created/updated
  - `user_tokens`: id, user_id, token_hash, scopes JSON, expires_at, revoked_at
  - `password_reset_tokens`: id, user_id, token_hash, expires_at, used_at, created_at
  - `audit_logs`: id, ts, actor_user_id, action, object_type, object_id, meta, ip, user_agent, request_id

### 2. **Admin API - –ø–∞–≥–∏–Ω–∞—Ü–∏—è –∏ –æ—à–∏–±–∫–∏** ‚úÖ
- **Cursor-based –ø–∞–≥–∏–Ω–∞—Ü–∏—è**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ `UserListResponse` —Å –ø–æ–ª—è–º–∏ `has_more`, `next_cursor`
- **–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –æ—à–∏–±–æ–∫**: ‚úÖ –í—Å–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `{error: {code, message}, request_id}`

### 3. **–ü–∞—Ä–æ–ª–∏ - –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é** ‚úÖ
- **Argon2id**: ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `app/core/security.py`
- **Pepper**: ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `PASSWORD_PEPPER` –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- **–í–∞–ª–∏–¥–∞—Ü–∏—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏**: ‚úÖ –ï–¥–∏–Ω—ã–π –≤–∞–ª–∏–¥–∞—Ç–æ—Ä `validate_password_strength()`

### 4. **Refresh-—Ç–æ–∫–µ–Ω—ã - one-time rotation** ‚úÖ
- **–†–æ—Ç–∞—Ü–∏—è**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ `app/services/auth_service.py`
- **–•—Ä–∞–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π**: ‚úÖ –í —Ç–∞–±–ª–∏—Ü–µ `user_refresh_tokens`
- **–û—Ç–∑—ã–≤ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø–∞—Ä–æ–ª—è**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ `password_reset.py`

### 5. **Cookie-—Ä–µ–∂–∏–º + CSRF** ‚úÖ
- **Cookie –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ `app/core/cookie_auth.py`
- **CSRF –∑–∞—â–∏—Ç–∞**: ‚úÖ Middleware –¥–ª—è CSRF —Ç–æ–∫–µ–Ω–æ–≤
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: ‚úÖ `AUTH_MODE`, `COOKIE_AUTH_ENABLED`, `CSRF_ENABLED`

### 6. **–ü–æ–ª–∏—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–æ–∫ –¥–ª—è reader** ‚úÖ
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–ª–∞–≥**: ‚úÖ `ALLOW_READER_UPLOADS` –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö**: ‚úÖ `require_upload_permission()` –≤ `app/api/deps.py`

### 7. **DELETE –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ** ‚úÖ
- **–ú—è–≥–∫–∞—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ `delete_user()` endpoint
- **–ü–æ–ª–∏—Ç–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è**: ‚úÖ `is_active=False` –≤–º–µ—Å—Ç–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è

### 8. **–ú–µ—Ç—Ä–∏–∫–∏ –ø–æ –∞–¥–º–∏–Ω-–æ–ø–µ—Ä–∞—Ü–∏—è–º** ‚úÖ
- **Admin –º–µ—Ç—Ä–∏–∫–∏**: ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –≤ `app/core/metrics.py`
  - `admin_operations_total`
  - `admin_user_operations_total`
  - `admin_token_operations_total`
  - `rate_limit_hits_total`
  - `auth_attempts_total`
  - `password_reset_requests_total`

### 9. **OpenAPI –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** ‚úÖ
- **–°—Ö–µ–º—ã Admin API**: ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ `app/schemas/admin.py`
- **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤**: ‚úÖ –í—Å–µ endpoints –∏–º–µ—é—Ç —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ö–µ–º—ã
- **–ü—Ä–∏–º–µ—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤**: ‚úÖ Pydantic –º–æ–¥–µ–ª–∏ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚úÖ Rate limiting –¥–ª—è –≤—Å–µ—Ö auth endpoints
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è PAT scopes —Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π
- ‚úÖ SSE heartbeat –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
- ‚úÖ Password reset –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200
- ‚úÖ Audit logging –≤—Å–µ—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- ‚úÖ –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ environment variables
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `env.example` —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
- ‚úÖ Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ Comprehensive test suite
- ‚úÖ –¢–µ—Å—Ç—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –¢–ó (`test_tz_compliance.py`)
- ‚úÖ –°–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚úÖ Makefile –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤

## üìä –°—Ç–∞—Ç—É—Å –ø–æ —á–µ–∫-–ª–∏—Å—Ç—É

| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –¢–ó | –°—Ç–∞—Ç—É—Å | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è |
|---------------|--------|------------|
| **–ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö** | ‚úÖ | CHECK constraint, –≤—Å–µ –ø–æ–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç |
| **Cursor –ø–∞–≥–∏–Ω–∞—Ü–∏—è** | ‚úÖ | `has_more`, `next_cursor` –≤ –æ—Ç–≤–µ—Ç–∞—Ö |
| **–§–æ—Ä–º–∞—Ç –æ—à–∏–±–æ–∫** | ‚úÖ | `{error: {code, message}, request_id}` |
| **Argon2id –ø–∞—Ä–æ–ª–∏** | ‚úÖ | –° pepper –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ |
| **Refresh rotation** | ‚úÖ | One-time —Å —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤–µ—Ä—Å–∏–π |
| **Cookie —Ä–µ–∂–∏–º** | ‚úÖ | –° CSRF –∑–∞—â–∏—Ç–æ–π |
| **Reader uploads** | ‚úÖ | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–π —Ñ–ª–∞–≥ |
| **–ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ** | ‚úÖ | `is_active=False` |
| **Admin –º–µ—Ç—Ä–∏–∫–∏** | ‚úÖ | Prometheus –º–µ—Ç—Ä–∏–∫–∏ |
| **OpenAPI —Å—Ö–µ–º—ã** | ‚úÖ | –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã |

## üöÄ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

```bash
# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –¢–ó
make test-tz-compliance

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
make test-security

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ RBAC
make test-rbac

# –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π
make run-migrations

# –°–æ–∑–¥–∞–Ω–∏–µ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
make create-superuser
```

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–í—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã!** 

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å –ø–æ–ª–Ω—ã–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ–º –¢–ó –ø–æ:
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (Argon2id, rate limiting, CSRF)
- ‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ (RBAC, PAT, audit logging)
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (cursor pagination, SSE heartbeat)
- ‚úÖ –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç–∏ (–º–µ—Ç—Ä–∏–∫–∏, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é (comprehensive test suite)

**–°—Ç–∞—Ç—É—Å: üéØ –ü–û–õ–ù–û–ï –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –¢–ó**
