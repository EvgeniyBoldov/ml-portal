import{r,j as e}from"./index-FkM6qUsl.js";import{C as B}from"./Card-B3djX2B0.js";import{I as C}from"./Input-THmdJdCV.js";import{B as c}from"./Button-t5z5qQ-u.js";import{B as b,F as j,a as P}from"./FilePicker-CYu4nJAl.js";import{M as z}from"./Modal-Cg6TzCa0.js";import{P as T}from"./Popover-rf5hZEbw.js";import{S as W}from"./Select-CqlyniY_.js";import{a as N}from"./http-B8UuqdIS.js";import"./idempotency-C3fxGORY.js";async function E(){return N("/analyze")}async function I(i){const d=new FormData;return d.set("file",i),N("/analyze/upload",{method:"POST",body:d})}const M="_wrap_1uqga_1",O="_card_1uqga_6",R="_header_1uqga_19",D="_title_1uqga_26",Q="_controls_1uqga_32",U="_search_1uqga_39",G="_tableWrap_1uqga_43",n={wrap:M,card:O,header:R,title:D,controls:Q,search:U,tableWrap:G};function te(){const[i,d]=r.useState([]),[k,y]=r.useState(!1),[u,S]=r.useState(""),[a,h]=r.useState({}),[p,f]=r.useState({open:!1}),[q,x]=r.useState(!1),[g,v]=r.useState(null);async function w(){const s=await E();d(s.items||[])}r.useEffect(()=>{let s=!1,t=1500;return(async()=>{for(;!s;){try{await w()}catch(o){console.error("Error refreshing:",o)}await new Promise(o=>setTimeout(o,t)),t=Math.min(t*2,1e4)}})(),()=>{s=!0}},[]);const _=r.useMemo(()=>(i||[]).filter(s=>{const t=((s.source||"")+" "+(s.result||"")+" "+(s.created_at||"")+" "+s.status).toLowerCase();return!(u.trim()&&!t.includes(u.toLowerCase())||a.source&&!(s.source||"").toLowerCase().includes((a.source||"").toLowerCase())||a.status&&s.status!==a.status||a.result&&!(s.result||"").toLowerCase().includes((a.result||"").toLowerCase())||a.created_at&&!(s.created_at||"").toLowerCase().includes((a.created_at||"").toLowerCase()))}),[i,u,a]);function m(s,t){const l=t.getBoundingClientRect();f({open:!0,col:s,anchor:{x:l.left,y:l.bottom+6}})}function F(){h({}),f({open:!1})}async function L(){if(g){y(!0);try{await I(g),x(!1),v(null),await w()}finally{y(!1)}}}const A=Object.values(a).some(Boolean);return e.jsxs("div",{className:n.wrap,children:[e.jsxs(B,{className:n.card,children:[e.jsxs("div",{className:n.header,children:[e.jsx("div",{className:n.title,children:"Анализ документов — задачи"}),e.jsxs("div",{className:n.controls,children:[e.jsx(C,{className:n.search,placeholder:"Поиск…",value:u,onChange:s=>S(s.target.value)}),A&&e.jsx(b,{onClick:F,children:"Сбросить фильтры"}),e.jsx(c,{onClick:()=>x(!0),children:"Добавить"})]})]}),e.jsx("div",{className:n.tableWrap,children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsxs("th",{children:["Источник"," ",e.jsx("button",{className:"icon",type:"button","aria-label":"Фильтр по источнику",onClick:s=>m("source",s.currentTarget),children:e.jsx(j,{})})]}),e.jsxs("th",{children:["Статус"," ",e.jsx("button",{className:"icon",type:"button","aria-label":"Фильтр по статусу",onClick:s=>m("status",s.currentTarget),children:e.jsx(j,{})})]}),e.jsxs("th",{children:["Результат"," ",e.jsx("button",{className:"icon",type:"button","aria-label":"Фильтр по результату",onClick:s=>m("result",s.currentTarget),children:e.jsx(j,{})})]}),e.jsxs("th",{children:["Создано"," ",e.jsx("button",{className:"icon",type:"button","aria-label":"Фильтр по дате создания",onClick:s=>m("created_at",s.currentTarget),children:e.jsx(j,{})})]})]})}),e.jsxs("tbody",{children:[_.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"muted",children:s.source||"—"}),e.jsx("td",{children:e.jsx(b,{tone:s.status==="done"?"success":s.status==="error"?"danger":s.status==="processing"?"warn":"neutral",children:s.status})}),e.jsx("td",{style:{maxWidth:480,whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"},children:s.result||"—"}),e.jsx("td",{className:"muted",children:s.created_at||"—"})]},s.id)),_.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"muted",children:"Нет записей"})})]})]})})]}),e.jsx(z,{open:q,onClose:()=>x(!1),title:"Новый анализ",footer:e.jsxs(e.Fragment,{children:[e.jsx(c,{variant:"ghost",onClick:()=>x(!1),children:"Отмена"}),e.jsx(c,{onClick:L,disabled:k||!g,children:"Запустить"})]}),children:e.jsx(P,{onFileSelected:v})}),e.jsx(T,{trigger:e.jsx("div",{}),content:e.jsxs("div",{className:"stack",style:{minWidth:260},children:[p.col==="status"?e.jsxs(W,{value:a.status||"",onChange:s=>h(t=>({...t,status:s.target.value||void 0})),children:[e.jsx("option",{value:"",children:"Любой"}),e.jsx("option",{value:"queued",children:"queued"}),e.jsx("option",{value:"processing",children:"processing"}),e.jsx("option",{value:"done",children:"done"}),e.jsx("option",{value:"error",children:"error"})]}):e.jsx(C,{placeholder:"Фильтр…",value:a[p.col]||"",onChange:s=>{const t=s.target.value,l=p.col;h(o=>({...o,[l]:(t||"").trim()||void 0}))}}),e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"space-between"},children:[e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>{const s=p.col;h(t=>({...t,[s]:void 0}))},children:"Очистить"}),e.jsx(c,{size:"sm",onClick:()=>f({open:!1}),children:"Применить"})]})]}),align:"end"})]})}export{te as default};
